<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <link rel="icon" href="/assets/images/logo.png"> <title>Kube-proxy and mysterious DNS timeout | Charles Xu</title> <title>Kube-proxy and mysterious DNS timeout | Charles Xu</title> <meta name="generator" content="Jekyll v4.3.2"/> <meta property="og:title" content="Kube-proxy and mysterious DNS timeout"/> <meta property="og:locale" content="en_US"/> <meta name="description" content="This post reviews how iptables-mode kube-proxy works, why some DNS requests to kube-dns were blackholed, and how to mitigate the issue."/> <meta property="og:description" content="This post reviews how iptables-mode kube-proxy works, why some DNS requests to kube-dns were blackholed, and how to mitigate the issue."/> <meta property="og:site_name" content="Charles Xu"/> <meta property="og:image" content="/assets/images/kube-proxy-bug/cover2.jpg"/> <meta property="og:type" content="article"/> <meta property="article:published_time" content="2024-05-12T00:00:00+00:00"/> <meta name="twitter:card" content="summary_large_image"/> <meta property="twitter:image" content="/assets/images/kube-proxy-bug/cover2.jpg"/> <meta property="twitter:title" content="Kube-proxy and mysterious DNS timeout"/> <script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-05-12T00:00:00+00:00","datePublished":"2024-05-12T00:00:00+00:00","description":"This post reviews how iptables-mode kube-proxy works, why some DNS requests to kube-dns were blackholed, and how to mitigate the issue.","headline":"Kube-proxy and mysterious DNS timeout","image":"/assets/images/kube-proxy-bug/cover2.jpg","mainEntityOfPage":{"@type":"WebPage","@id":"/kube-proxy-bug/"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"/assets/images/logo.png"}},"url":"/kube-proxy-bug/"}</script> <link href="/assets/css/bootstrap.min.css" rel="stylesheet"> <script src="/assets/js/jquery.min.js"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-8CYZ0N0EWJ"></script> <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-8CYZ0N0EWJ");</script> <script>!function(e,t,a,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=t.createElement(a),s=t.getElementsByTagName(a)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-151349369-1","auto"),ga("send","pageview");</script> <script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "5b6e3d4ee3274005a2d3321f9bb0516c"}'></script> </head> <body class="layout-post"> <noscript id="deferred-styles"> <link href="/assets/css/fontawesome.css" rel="stylesheet"> <link href="/assets/css/google-fonts.css" rel="stylesheet"> </noscript> <nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top mediumnavigation nav-down"> <div class="container pr-0"> <a class="navbar-brand" href="/"> <img src="/assets/images/logo.png" alt="Charles Xu" height="32" width="32"> </a> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarMediumish" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <div class="collapse navbar-collapse" id="navbarMediumish"> <ul class="navbar-nav ml-auto"> <li class="nav-item"> <a class="nav-link" href="/about">About</a> </li> <li class="nav-item"> <a class="nav-link" href="/bookshelf">Bookshelf</a> </li> <li class="nav-item"> <a class="nav-link" href="/inspirations">Inspirations</a> </li> <li class="nav-item"> <a class="nav-link" href="/wiki">Wiki</a> </li> <li class="nav-item"> <a class="nav-link" href="/">Blog</a> </li> <script src="/assets/js/lunr.js"></script> <style>.lunrsearchresult .title{color:#d9230f}.lunrsearchresult .url{color:silver}.lunrsearchresult a{display:block;color:#777}.lunrsearchresult a:hover,.lunrsearchresult a:focus{text-decoration:none}.lunrsearchresult a:hover .title{text-decoration:underline}</style> <div style="width: 14px; height: 10px;"></div> <form class="bd-search" onSubmit="return lunr_search(document.getElementById('lunrsearch').value);"> <input type="text" class="form-control text-small launch-modal-search" id="lunrsearch" name="q" maxlength="255" value="" placeholder="Type and enter..."/> </form> <div id="lunrsearchresults"> <ul></ul> </div> <script src="/assets/js/lunrsearchengine.js"></script> </ul> </div> </div> </nav> <div class="site-content"> <div class="container"> <div class="mainheading"> <h1 class="sitetitle">Charles Xu</h1> <p class="lead"> Essays, books, wiki on technologies, career, markets, and more. </p> </div> <div id="loading"> <div id="loading-image" class="lds-ellipsis"><div></div><div></div><div></div><div></div></div> </div> <script>$(window).on("load",function(){$("#loading").hide()});</script> <div class="main-content"> <div class="container"> <div class="row"> <div class="col-md-2 pl-0"> <div class="share sticky-top sticky-top-offset"> <p> Share </p> <ul> <li class="ml-1 mr-1"> <a target="_blank" href="https://twitter.com/intent/tweet?text=Kube-proxy and mysterious DNS timeout&url=charlesxu.io/kube-proxy-bug/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;"> <i class="fab fa-twitter"></i> </a> </li> <li class="ml-1 mr-1"> <a target="_blank" href="https://facebook.com/sharer.php?u=charlesxu.io/kube-proxy-bug/" onclick="window.open(this.href, 'facebook-share', 'width=550,height=435');return false;"> <i class="fab fa-facebook-f"></i> </a> </li> <li class="ml-1 mr-1"> <a target="_blank" href="https://www.linkedin.com/shareArticle?mini=true&url=charlesxu.io/kube-proxy-bug/" onclick="window.open(this.href, 'width=550,height=435');return false;"> <i class="fab fa-linkedin-in"></i> </a> </li> </ul> <div class="sep"> </div> <ul> <li> <a class="small smoothscroll" href="#disqus_thread"></a> </li> </ul> </div> </div> <div class="col-md-8 flex-first flex-md-unordered"> <div class="mainheading"> <h1 class="posttitle">Kube-proxy and mysterious DNS timeout</h1> </div> <img class="featured-image img-fluid lazyimg" style="min-width: 100%" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAMAAAACCAQAAAA3fa6RAAAADklEQVR42mNkAANGCAUAACMAA2w/AMgAAAAASUVORK5CYII=" data-src="/assets/images/kube-proxy-bug/cover2.jpg" alt="Kube-proxy and mysterious DNS timeout"> <div class="article-post"> <div class="toc mt-4 mb-4 lead"> <h3 style="color: #9c9c9c">Table of Contents</h3> <ul> <li><a href="#background-how-kube-proxy-works">Background: How kube-proxy works</a></li> <li><a href="#why-some-dns-requests-were-blackholed">Why Some DNS Requests Were Blackholed</a></li> <li><a href="#mitigations">Mitigations</a></li> </ul> </div> <p>This post reviews how iptables-mode kube-proxy works, why some DNS requests to <code class="language-plaintext highlighter-rouge">kube-dns</code> were blackholed, and how to mitigate the issue.</p> <h3 id="background-how-kube-proxy-works">Background: How kube-proxy works</h3> <p>The kube-dns <code class="language-plaintext highlighter-rouge">Service</code> uses a label selector to select all CoreDNS Pods. The <code class="language-plaintext highlighter-rouge">Service</code> has a <code class="language-plaintext highlighter-rouge">ClusterIP</code>. Requests to such <code class="language-plaintext highlighter-rouge">ClusterIP</code> will be DNAT-ed to one of the CoreDNS Pod IPs. The DNAT is performed by kube-proxy, which runs as a DaemonSet. Kube-proxy is not a real proxy (data plane) but configures the <code class="language-plaintext highlighter-rouge">iptables</code> rules and <code class="language-plaintext highlighter-rouge">conntrack</code> tables on the Node to implement the DNAT.</p> <p>DNS is primarily over UDP. Although UDP is a connectionless protocol, kube-proxy still uses <code class="language-plaintext highlighter-rouge">conntrack</code> for UDP to remember the NAT translations applied to each pair of the source and destination IP addresses and ports, ensuring that responses can be correctly routed back to the originating Pod.</p> <p>When the CoreDNS Deployment had a rolling restart, new CoreDNS Pods had new IPs, and old CoreDNS Pods were removed so their IPs became stale. Thus, kube-proxy needs to update the Node’s <code class="language-plaintext highlighter-rouge">iptables</code> rules and <code class="language-plaintext highlighter-rouge">conntrack</code> tables.</p> <h3 id="why-some-dns-requests-were-blackholed">Why Some DNS Requests Were Blackholed</h3> <p>The concurrent restart of the kube-proxy DaemonSet and the CoreDNS Deployment created a race condition. Any DaemonSet, including kube-proxy, can not perform surge upgrade (i.e. bring up a new Pod on the same Node then remove the old Pod), because a DaemonSet guarantees there will be at most one kube-proxy Pod on a Node. Thus, when kube-proxy was in upgrade, Kubelet must terminate the existing kube-proxy Pod, then start a new one. In between the delete-then-create, there may be new CoreDNS Pods coming up and old CoreDNS Pods removed. This creates two problems:</p> <ol> <li> <p>Until the new kube-proxy Pod was up and ensured iptables and conntrack were up to date, traffic to CoreDNS might be routed to a stale Pod IP that no longer exists (the IP of a deleted CoreDNS Pod). Pod IP works as secondary (alias) IP ranges on the Node. The destination Node’s iptables will just drop the packet if no matching Pod IP.</p> </li> <li> <p>In some cases, new kube-proxy Pod cannot remove stale rules. Some kube-proxy Pod’s log showed (reformatted to be more readable):</p> </li> </ol> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>"Failed to delete endpoint connections"
error deleting conntrack entries for udp peer {172.20.0.10, 10.6.30.154},
conntrack command returned:
conntrack v1.4.4 (conntrack-tools):
Operation failed: such conntrack doesn't exist
udp      17 2 src=10.6.12.242 dst=172.20.0.10 sport=42451 dport=53 src=10.6.30.154 dst=10.6.12.242 sport=53 dport=42451 mark=0 use=1
udp      17 28 src=10.6.5.121 dst=172.20.0.10 sport=53669 dport=53 src=10.6.30.154 dst=10.6.5.121 sport=53 dport=53669 mark=0 use=1
udp      17 1 src=10.6.10.175 dst=172.20.0.10 sport=36264 dport=53 src=10.6.30.154 dst=10.6.10.175 sport=53 dport=36264 mark=0 use=1
error message: exit status 1
servicePortName="kube-system/kube-dns:dns"
</pre></td></tr></tbody></table></code></pre></div></div> <p>The source code that produces such an error message is <a href="https://github.com/kubernetes/kubernetes/blob/v1.28.9/pkg/proxy/conntrack/conntrack.go#L100-L103">here</a> and has the comment below. The “TODO” is still on the main branch of Kubernetes.</p> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="c">// TODO: Better handling for deletion failure.</span>
<span class="c">// When failure occur, stale udp connection may not get flushed.</span>
<span class="c">// These stale udp connection will keep black hole traffic.</span>
<span class="c">// Making this a best effort operation for now, since it</span>
<span class="c">// is expensive to baby sit all udp connections to kubernetes services.</span>

<span class="k">return</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"error deleting conntrack entries for udp peer {%s, %s}, error: %v"</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div> <p>Unfortunately, <code class="language-plaintext highlighter-rouge">conntrack</code> has no log files, and the kube-proxy log is not verbose enough to provide more insight into <code class="language-plaintext highlighter-rouge">conntrack</code>.</p> <p>Once kube-proxy got an error from <code class="language-plaintext highlighter-rouge">conntrack</code>, it does not retry, as shown in the source code (<a href="https://github.com/kubernetes/kubernetes/blob/44bd04c0cbddde69aaeb7a90d3bd3de4e417f27f/pkg/proxy/conntrack/cleanup.go#L97">1</a>, <a href="https://github.com/kubernetes/kubernetes/blob/v1.28.9/pkg/proxy/conntrack/conntrack.go#L95">2</a>, <a href="https://github.com/kubernetes/kubernetes/blob/v1.28.9/pkg/proxy/conntrack/conntrack.go#L61">3</a>).</p> <h3 id="mitigations">Mitigations</h3> <p><strong>Cordon and drain all affected Nodes</strong>. Find affected Notes by searching for logs <code class="language-plaintext highlighter-rouge">Failed to delete endpoint connections</code>. To assist forensic analysis, prevent the node from being deleted by cluster-autoscaler by annotating the node with “cluster-autoscaler.kubernetes.io/scale-down-disabled=true” (<a href="https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/FAQ.md#how-can-i-prevent-cluster-autoscaler-from-scaling-down-a-particular-node">doc</a>)</p> <p><strong>Run kube-proxy with verbose level 4 to get more details about UDP connections</strong>, such as why conntrack exited 1. See https://github.com/kubernetes/kubernetes/pull/95694</p> <p><strong>Per-node DNS monitoring</strong>. Deploy the <a href="https://github.com/kubernetes/node-problem-detector">node-problem-detector</a> as DaemonSet on every cluster. Build a plugin for DNS monitoring. Bonus point is that this agent will be a generalized framework for node-locel issue detection. For example, you may want to cover machine learning use cases such as detecting bad TensorCore Silicon and ECC errors.</p> <p><strong>Deploy node-local-dns</strong>. <a href="https://kubernetes.io/docs/tasks/administer-cluster/nodelocaldns/">Node-local-dns</a> allows DNS lookup to skip iptables DNAT and connection tracking. Connections from the node-local caching agent to the kube-dns service are upgraded to TCP. TCP conntrack entries will be removed on connection close and would reduce tail latency attributed to dropped UDP packets. Observability of DNS requests at a node level.</p> <p><em>If you run EKS, you may be self-managing kube-proxy, or use the EKS-managed one. Both options require you to manage the life cycle of kube-proxy. Consider hardening the kube-proxy lifecycle management process with:</em></p> <p><strong>Log-based metrics for kube-proxy errors</strong>. Alert the person on-call about such errors.</p> <p><strong>Upgrade kube-proxy only on node pools of a new kubernetes version</strong>. Don’t do in-place upgrade of kube-proxy. GKE and AKS consider kube-proxy a managed component similar to kubelet, and they upgrade kube-proxy only if the node version is upgraded. We should do the same.</p> <p><strong>Don’t upgrade coredns and kube-proxy together</strong>. Define a strong dependency and ordering between the two.</p> </div> <p> <small> <span class="post-date"><time class="post-date" datetime="2024-05-12">12 May 2024</time></span> </small> </p> <div class="after-post-cats"> <ul class="tags mb-4"> <li> <a class="smoothscroll" href="/categories#cloud">cloud</a> </li> <li> <a class="smoothscroll" href="/categories#kubernetes">kubernetes</a> </li> <li> <a class="smoothscroll" href="/categories#microservices">microservices</a> </li> <li> <a class="smoothscroll" href="/categories#networking">networking</a> </li> </ul> </div> <div class="after-post-tags"> <ul class="tags"> </ul> </div> <div class="row PageNavigation d-flex justify-content-between font-weight-bold"> <a class="prev d-block col-md-6" href="/lean-startup/"> &laquo; Notes: The Lean Startup</a> <div class="clearfix"></div> </div> </div> </div> </div> </div> <div class="alertbar"> <div class="container text-center"> <span><img src="/assets/images/logo.png" alt="Charles Xu" height="32" width="32"> &nbsp; Never miss a <b>story</b> from me, subscribe to my newsletter</span> <form action="https://gmail.us5.list-manage.com/subscribe/post?u=b3d456844a3860642cd584c1b&amp;id=3f0c5c8bcd" method="post" name="mc-embedded-subscribe-form" class="wj-contact-form validate" target="_blank" novalidate> <div class="mc-field-group"> <input type="email" placeholder="Email" name="EMAIL" class="required email" id="mce-EMAIL" autocomplete="on" required> <input type="submit" value="Subscribe" name="subscribe" class="heart"> </div> </form> </div> </div> </div> <div class="jumbotron fortags"> <div class="d-md-flex h-100"> <div class="col-md-4 transpdark align-self-center text-center h-100"> <div class="d-md-flex align-items-center justify-content-center h-100"> <h2 class="d-md-block align-self-center py-1 font-weight-light">Explore <span class="d-none d-md-inline">→</span></h2> </div> </div> <div class="col-md-8 p-5 align-self-center text-center"> <a class="mt-1 mb-1" href="/categories#git">git (3)</a> <a class="mt-1 mb-1" href="/categories#web">web (9)</a> <a class="mt-1 mb-1" href="/categories#microservices">microservices (9)</a> <a class="mt-1 mb-1" href="/categories#distributed-systems">distributed systems (6)</a> <a class="mt-1 mb-1" href="/categories#signal-processing">signal processing (1)</a> <a class="mt-1 mb-1" href="/categories#networking">networking (12)</a> <a class="mt-1 mb-1" href="/categories#istio">istio (4)</a> <a class="mt-1 mb-1" href="/categories#security">security (1)</a> <a class="mt-1 mb-1" href="/categories#docker">docker (2)</a> <a class="mt-1 mb-1" href="/categories#kubernetes">kubernetes (10)</a> <a class="mt-1 mb-1" href="/categories#operation">operation (4)</a> <a class="mt-1 mb-1" href="/categories#career">career (5)</a> <a class="mt-1 mb-1" href="/categories#go">go (1)</a> <a class="mt-1 mb-1" href="/categories#cloud">cloud (5)</a> <a class="mt-1 mb-1" href="/categories#investment">investment (2)</a> <a class="mt-1 mb-1" href="/categories#startup">startup (6)</a> <a class="mt-1 mb-1" href="/categories#oss">oss (1)</a> </div> </div> </div> <footer class="footer"> <div class="container"> <div class="row"> <div class="col-md-6 col-sm-6 text-center text-lg-left" style="margin-bottom: 10px;"> Copyright © 2016-2024 Charles Xu </div> </div> </div> </footer> </div> <script src="/assets/js/popper.min.js"></script> <script src="/assets/js/bootstrap.min.js"></script> <script src="/assets/js/mediumish.js"></script> <script src="/assets/js/lazyload.js"></script> <script src="/assets/js/ie10-viewport-bug-workaround.js"></script> <link href="/assets/css/screen.css" rel="stylesheet"> <link href="/assets/css/main.css" rel="stylesheet"> </body> </html>