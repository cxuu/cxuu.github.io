<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <link rel="icon" href="/assets/images/logo.png"> <title>DNS, UDP, IP Anycast, and All That | Charles Xu</title> <title>DNS, UDP, IP Anycast, and All That | Charles Xu</title> <meta name="generator" content="Jekyll v4.2.0"/> <meta property="og:title" content="DNS, UDP, IP Anycast, and All That"/> <meta property="og:locale" content="en_US"/> <meta name="description" content="DNS prefers UDP. There are times when DNS must run on TCP (request or response size exceeds a single packet, perhaps due to too many response records), but UDP is perferred if possible. The reasons are Constraints from IP Anycasts that favor stateless applications such as DNS. Performance gain with UDP over TCP (2 vs 11 IP packets, no connection state management)."/> <meta property="og:description" content="DNS prefers UDP. There are times when DNS must run on TCP (request or response size exceeds a single packet, perhaps due to too many response records), but UDP is perferred if possible. The reasons are Constraints from IP Anycasts that favor stateless applications such as DNS. Performance gain with UDP over TCP (2 vs 11 IP packets, no connection state management)."/> <meta property="og:site_name" content="Charles Xu"/> <meta property="og:image" content="/assets/images/dns-udp/cover.jpg"/> <meta property="og:type" content="article"/> <meta property="article:published_time" content="2020-04-05T00:00:00-07:00"/> <meta name="twitter:card" content="summary_large_image"/> <meta property="twitter:image" content="/assets/images/dns-udp/cover.jpg"/> <meta property="twitter:title" content="DNS, UDP, IP Anycast, and All That"/> <script type="application/ld+json">
{"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"/assets/images/logo.png"}},"url":"/dns-udp/","image":"/assets/images/dns-udp/cover.jpg","headline":"DNS, UDP, IP Anycast, and All That","dateModified":"2020-04-05T00:00:00-07:00","datePublished":"2020-04-05T00:00:00-07:00","mainEntityOfPage":{"@type":"WebPage","@id":"/dns-udp/"},"description":"DNS prefers UDP. There are times when DNS must run on TCP (request or response size exceeds a single packet, perhaps due to too many response records), but UDP is perferred if possible. The reasons are Constraints from IP Anycasts that favor stateless applications such as DNS. Performance gain with UDP over TCP (2 vs 11 IP packets, no connection state management).","@type":"BlogPosting","@context":"https://schema.org"}</script> <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous"> <script src="/assets/js/jquery.min.js"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-8CYZ0N0EWJ"></script> <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-8CYZ0N0EWJ");</script> <script>!function(e,t,a,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=t.createElement(a),s=t.getElementsByTagName(a)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-151349369-1","auto"),ga("send","pageview");</script> <script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "5b6e3d4ee3274005a2d3321f9bb0516c"}'></script> </head> <body class="layout-post"> <noscript id="deferred-styles"> <link href="https://fonts.googleapis.com/css?family=Righteous%7CMerriweather:300,300i,400,400i,700,700i" rel="stylesheet"> <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous"> </noscript> <nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top mediumnavigation nav-down"> <div class="container pr-0"> <a class="navbar-brand" href="/"> <img src="/assets/images/logo.png" alt="Charles Xu" height="32" width="32"> </a> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarMediumish" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <div class="collapse navbar-collapse" id="navbarMediumish"> <ul class="navbar-nav ml-auto"> <li class="nav-item"> <a class="nav-link" href="/about">About</a> </li> <li class="nav-item"> <a class="nav-link" href="/bookshelf">Bookshelf</a> </li> <li class="nav-item"> <a class="nav-link" href="/inspirations">Inspirations</a> </li> <li class="nav-item"> <a class="nav-link" href="/wiki">Wiki</a> </li> <li class="nav-item"> <a class="nav-link" href="/">Blog</a> </li> <script src="/assets/js/lunr.js"></script> <style>.lunrsearchresult .title{color:#d9230f}.lunrsearchresult .url{color:silver}.lunrsearchresult a{display:block;color:#777}.lunrsearchresult a:hover,.lunrsearchresult a:focus{text-decoration:none}.lunrsearchresult a:hover .title{text-decoration:underline}</style> <div style="width: 14px; height: 10px;"></div> <form class="bd-search" onSubmit="return lunr_search(document.getElementById('lunrsearch').value);"> <input type="text" class="form-control text-small launch-modal-search" id="lunrsearch" name="q" maxlength="255" value="" placeholder="Type and enter..."/> </form> <div id="lunrsearchresults"> <ul></ul> </div> <script src="/assets/js/lunrsearchengine.js"></script> </ul> </div> </div> </nav> <div class="site-content"> <div class="container"> <div class="mainheading"> <h1 class="sitetitle">Charles Xu</h1> <p class="lead"> Essays, books, wiki on technologies, career, markets, and more. </p> </div> <div class="main-content"> <div class="container"> <div class="row"> <div class="col-md-2 pl-0"> <div class="share sticky-top sticky-top-offset"> <p> Share </p> <ul> <li class="ml-1 mr-1"> <a target="_blank" href="https://twitter.com/intent/tweet?text=DNS, UDP, IP Anycast, and All That&url=charlesxu.io/dns-udp/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;"> <i class="fab fa-twitter"></i> </a> </li> <li class="ml-1 mr-1"> <a target="_blank" href="https://facebook.com/sharer.php?u=charlesxu.io/dns-udp/" onclick="window.open(this.href, 'facebook-share', 'width=550,height=435');return false;"> <i class="fab fa-facebook-f"></i> </a> </li> <li class="ml-1 mr-1"> <a target="_blank" href="https://www.linkedin.com/shareArticle?mini=true&url=charlesxu.io/dns-udp/" onclick="window.open(this.href, 'width=550,height=435');return false;"> <i class="fab fa-linkedin-in"></i> </a> </li> </ul> <div class="sep"> </div> <ul> <li> <a class="small smoothscroll" href="#disqus_thread"></a> </li> </ul> </div> </div> <div class="col-md-8 flex-first flex-md-unordered"> <div class="mainheading"> <h1 class="posttitle">DNS, UDP, IP Anycast, and All That</h1> </div> <img class="featured-image img-fluid lazyimg" style="min-width: 100%" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAMAAAACCAQAAAA3fa6RAAAADklEQVR42mNkAANGCAUAACMAA2w/AMgAAAAASUVORK5CYII=" data-src="/assets/images/dns-udp/cover.jpg" alt="DNS, UDP, IP Anycast, and All That"> <div class="article-post"> <p>DNS prefers UDP. There are times when DNS must run on TCP (request or response size exceeds a single packet, perhaps due to too many response records), but UDP is perferred if possible. The reasons are</p> <ul> <li>Constraints from IP Anycasts that favor stateless applications such as DNS.</li> <li>Performance gain with UDP over TCP (2 vs 11 IP packets, no connection state management).</li> </ul> <h3 id="ip-anycast">IP Anycast</h3> <p>Anycast is one of the five <a href="https://en.wikipedia.org/wiki/Anycast#Addressing_methods">addressing methods</a> in IP, where multiple endpoint destinations share the same address. A request to such address expects only one response from any of the destinations. Routers may select the desired path based on costs, latency, and congestion. Another addressing method, Unicast address uniquely identifies a single receiver endpoint.</p> <p>Anycast can be implemented by using <a href="https://en.wikipedia.org/wiki/Border_Gateway_Protocol">Border Gateway Protocol</a> (BGP) and Unicast. Multiple hosts (likely in different regions) are given the same unicast IP address. Different routes to the address are advertised through BGP, as if they are alternative routes to the same destination when in fact they actually route to different destinations with the same address. As usual, routers select a route by whatever metric (cost, congestion, distance, etc). Selecting a route in this design amounts to selecting a destination.</p> <p>However, routing changes could break open connections to an anycast address, since IP packets could be routed to a different host that has no context on the connection state (such as TCP sequence numbers). With a normal unicast address, a routing change is not a problem at all, as packets eventually arrive at the same destination.</p> <p>Hence, anycast is often used with connection-less protocols to provide high availability and load balancing for stateless services. DNS is a great fit. The root name servers need to be accessible at a well-known address (or we need another name server to find these name servers but what is the address to that name server?). The actual backend serving the query should be as close as possible to reduce response latency (as DNS lookup is often in the hot path before TCP, TLS, and finally HTTP).</p> <h3 id="udp">UDP</h3> <p>UDP is best-effort (unreliable) and packets may be delivered out-of-order. However, a DNS query usually fits in a single packet and does not require an ordered byte stream. Hence, out-of-order delivery is not an issue; checksum and retransmission are enough to ensure integrity. In comparison, queries over TCP require 11 IP packets to complete:</p> <ul> <li>Three-way handshake to establish connection (SYN, SYN-ACK, ACK)</li> <li>Query by client, ACK by server</li> <li>Response by server, ACK by client</li> <li>Four-way handshake to close connection (FIN, ACK, FIN, ACK)</li> </ul> <p>Using UDP allows the name server to scale better because it does not allocate or manage connection states, such as Receive and Send buffers, Sequence and Acknowledge Numbers, and flow-control and congestion-control parameters, etc.</p> </div> <p> <small> <span class="post-date"><time class="post-date" datetime="2020-04-05">05 Apr 2020</time></span> </small> </p> <div class="after-post-cats"> <ul class="tags mb-4"> <li> <a class="smoothscroll" href="/categories#networking">networking</a> </li> </ul> </div> <div class="after-post-tags"> <ul class="tags"> </ul> </div> <div class="row PageNavigation d-flex justify-content-between font-weight-bold"> <a class="prev d-block col-md-6" href="/gke-scaling/"> &laquo; Lessons from Scaling GKE: L4 ILB Tops at 250 Nodes</a> <a class="next d-block col-md-6 text-lg-right" href="/istio-short/">The Good, Bad, and Ugly: Istio for Short-lived Pods &raquo; </a> <div class="clearfix"></div> </div> </div> </div> </div> </div> <div class="alertbar"> <div class="container text-center"> <span><img src="/assets/images/logo.png" alt="Charles Xu" height="32" width="32"> &nbsp; Never miss a <b>story</b> from me, subscribe to my newsletter</span> <form action="https://gmail.us5.list-manage.com/subscribe/post?u=b3d456844a3860642cd584c1b&amp;id=3f0c5c8bcd" method="post" name="mc-embedded-subscribe-form" class="wj-contact-form validate" target="_blank" novalidate> <div class="mc-field-group"> <input type="email" placeholder="Email" name="EMAIL" class="required email" id="mce-EMAIL" autocomplete="on" required> <input type="submit" value="Subscribe" name="subscribe" class="heart"> </div> </form> </div> </div> </div> <div class="jumbotron fortags"> <div class="d-md-flex h-100"> <div class="col-md-4 transpdark align-self-center text-center h-100"> <div class="d-md-flex align-items-center justify-content-center h-100"> <h2 class="d-md-block align-self-center py-1 font-weight-light">Explore <span class="d-none d-md-inline">→</span></h2> </div> </div> <div class="col-md-8 p-5 align-self-center text-center"> <a class="mt-1 mb-1" href="/categories#git">git (3)</a> <a class="mt-1 mb-1" href="/categories#web">web (6)</a> <a class="mt-1 mb-1" href="/categories#microservices">microservices (3)</a> <a class="mt-1 mb-1" href="/categories#distributed-systems">distributed systems (4)</a> <a class="mt-1 mb-1" href="/categories#signal-processing">signal processing (1)</a> <a class="mt-1 mb-1" href="/categories#istio">istio (3)</a> <a class="mt-1 mb-1" href="/categories#security">security (1)</a> <a class="mt-1 mb-1" href="/categories#docker">docker (2)</a> <a class="mt-1 mb-1" href="/categories#interview">interview (1)</a> <a class="mt-1 mb-1" href="/categories#kubernetes">kubernetes (4)</a> <a class="mt-1 mb-1" href="/categories#operation">operation (2)</a> <a class="mt-1 mb-1" href="/categories#networking">networking (2)</a> <a class="mt-1 mb-1" href="/categories#career">career (4)</a> <a class="mt-1 mb-1" href="/categories#go">go (1)</a> <a class="mt-1 mb-1" href="/categories#shell">shell (1)</a> <a class="mt-1 mb-1" href="/categories#investment">investment (1)</a> <a class="mt-1 mb-1" href="/categories#law">law (1)</a> <a class="mt-1 mb-1" href="/categories#startup">startup (2)</a> <a class="mt-1 mb-1" href="/categories#accounting">accounting (1)</a> </div> </div> </div> <footer class="footer"> <div class="container"> <div class="row"> <div class="col-md-6 col-sm-6 text-center text-lg-left" style="margin-bottom: 10px;"> Copyright © 2016-2021 Charles Xu </div> </div> </div> </footer> </div> <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script> <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script> <script src="/assets/js/mediumish.js"></script> <script src="/assets/js/lazyload.js"></script> <script src="/assets/js/ie10-viewport-bug-workaround.js"></script> <link href="/assets/css/screen.css" rel="stylesheet"> <link href="/assets/css/main.css" rel="stylesheet"> </body> </html>