<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <link rel="icon" href="/assets/images/logo.png"> <title>How to Configure Applications for High Availability in Kubernetes | Charles Xu</title> <title>How to Configure Applications for High Availability in Kubernetes | Charles Xu</title> <meta name="generator" content="Jekyll v4.3.2"/> <meta property="og:title" content="How to Configure Applications for High Availability in Kubernetes"/> <meta property="og:locale" content="en_US"/> <meta name="description" content="Pods in Kubernetes are the smallest orchestration unit and are ephemeral by definition: Deployment/StatefulSet/DaemonSet/ReplicaSet updates or patches Nodepool downscaling (compaction) or upgrades (cordoned and drained)"/> <meta property="og:description" content="Pods in Kubernetes are the smallest orchestration unit and are ephemeral by definition: Deployment/StatefulSet/DaemonSet/ReplicaSet updates or patches Nodepool downscaling (compaction) or upgrades (cordoned and drained)"/> <meta property="og:site_name" content="Charles Xu"/> <meta property="og:image" content="/assets/images/k8s-ha/cover.jpg"/> <meta property="og:type" content="article"/> <meta property="article:published_time" content="2019-12-29T00:00:00+00:00"/> <meta name="twitter:card" content="summary_large_image"/> <meta property="twitter:image" content="/assets/images/k8s-ha/cover.jpg"/> <meta property="twitter:title" content="How to Configure Applications for High Availability in Kubernetes"/> <script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2019-12-29T00:00:00+00:00","datePublished":"2019-12-29T00:00:00+00:00","description":"Pods in Kubernetes are the smallest orchestration unit and are ephemeral by definition: Deployment/StatefulSet/DaemonSet/ReplicaSet updates or patches Nodepool downscaling (compaction) or upgrades (cordoned and drained)","headline":"How to Configure Applications for High Availability in Kubernetes","image":"/assets/images/k8s-ha/cover.jpg","mainEntityOfPage":{"@type":"WebPage","@id":"/k8s-ha/"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"/assets/images/logo.png"}},"url":"/k8s-ha/"}</script> <link href="/assets/css/bootstrap.min.css" rel="stylesheet"> <script src="/assets/js/jquery.min.js"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-8CYZ0N0EWJ"></script> <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-8CYZ0N0EWJ");</script> <script>!function(e,t,a,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=t.createElement(a),s=t.getElementsByTagName(a)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-151349369-1","auto"),ga("send","pageview");</script> <script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "5b6e3d4ee3274005a2d3321f9bb0516c"}'></script> </head> <body class="layout-post"> <noscript id="deferred-styles"> <link href="/assets/css/fontawesome.css" rel="stylesheet"> <link href="/assets/css/google-fonts.css" rel="stylesheet"> </noscript> <nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top mediumnavigation nav-down"> <div class="container pr-0"> <a class="navbar-brand" href="/"> <img src="/assets/images/logo.png" alt="Charles Xu" height="32" width="32"> </a> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarMediumish" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <div class="collapse navbar-collapse" id="navbarMediumish"> <ul class="navbar-nav ml-auto"> <li class="nav-item"> <a class="nav-link" href="/about">About</a> </li> <li class="nav-item"> <a class="nav-link" href="/bookshelf">Bookshelf</a> </li> <li class="nav-item"> <a class="nav-link" href="/inspirations">Inspirations</a> </li> <li class="nav-item"> <a class="nav-link" href="/wiki">Wiki</a> </li> <li class="nav-item"> <a class="nav-link" href="/">Blog</a> </li> <script src="/assets/js/lunr.js"></script> <style>.lunrsearchresult .title{color:#d9230f}.lunrsearchresult .url{color:silver}.lunrsearchresult a{display:block;color:#777}.lunrsearchresult a:hover,.lunrsearchresult a:focus{text-decoration:none}.lunrsearchresult a:hover .title{text-decoration:underline}</style> <div style="width: 14px; height: 10px;"></div> <form class="bd-search" onSubmit="return lunr_search(document.getElementById('lunrsearch').value);"> <input type="text" class="form-control text-small launch-modal-search" id="lunrsearch" name="q" maxlength="255" value="" placeholder="Type and enter..."/> </form> <div id="lunrsearchresults"> <ul></ul> </div> <script src="/assets/js/lunrsearchengine.js"></script> </ul> </div> </div> </nav> <div class="site-content"> <div class="container"> <div class="mainheading"> <h1 class="sitetitle">Charles Xu</h1> <p class="lead"> Essays, books, wiki on technologies, career, markets, and more. </p> </div> <div id="loading"> <div id="loading-image" class="lds-ellipsis"><div></div><div></div><div></div><div></div></div> </div> <script>$(window).on("load",function(){$("#loading").hide()});</script> <div class="main-content"> <div class="container"> <div class="row"> <div class="col-md-2 pl-0"> <div class="share sticky-top sticky-top-offset"> <p> Share </p> <ul> <li class="ml-1 mr-1"> <a target="_blank" href="https://twitter.com/intent/tweet?text=How to Configure Applications for High Availability in Kubernetes&url=charlesxu.io/k8s-ha/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;"> <i class="fab fa-twitter"></i> </a> </li> <li class="ml-1 mr-1"> <a target="_blank" href="https://facebook.com/sharer.php?u=charlesxu.io/k8s-ha/" onclick="window.open(this.href, 'facebook-share', 'width=550,height=435');return false;"> <i class="fab fa-facebook-f"></i> </a> </li> <li class="ml-1 mr-1"> <a target="_blank" href="https://www.linkedin.com/shareArticle?mini=true&url=charlesxu.io/k8s-ha/" onclick="window.open(this.href, 'width=550,height=435');return false;"> <i class="fab fa-linkedin-in"></i> </a> </li> </ul> <div class="sep"> </div> <ul> <li> <a class="small smoothscroll" href="#disqus_thread"></a> </li> </ul> </div> </div> <div class="col-md-8 flex-first flex-md-unordered"> <div class="mainheading"> <h1 class="posttitle">How to Configure Applications for High Availability in Kubernetes</h1> </div> <img class="featured-image img-fluid lazyimg" style="min-width: 100%" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAMAAAACCAQAAAA3fa6RAAAADklEQVR42mNkAANGCAUAACMAA2w/AMgAAAAASUVORK5CYII=" data-src="/assets/images/k8s-ha/cover.jpg" alt="How to Configure Applications for High Availability in Kubernetes"> <div class="article-post"> <div class="toc mt-4 mb-4 lead"> <h3 style="color: #9c9c9c">Table of Contents</h3> <ul> <li><a href="#pod">Pod</a> <ul> <li><a href="#graceful-termination">Graceful Termination</a></li> <li><a href="#health-checks">Health Checks</a> <ul> <li><a href="#readiness-probes">Readiness Probes</a></li> <li><a href="#liveness-probes">Liveness Probes</a></li> <li><a href="#startup-probes">Startup Probes</a></li> </ul> </li> <li><a href="#priority-class">Priority Class</a></li> <li><a href="#resource-requirements-and-quotas">Resource Requirements and Quotas</a></li> </ul> </li> <li><a href="#replicated-pods">Replicated Pods</a> <ul> <li><a href="#load-balancing---ingress-and-service">Load Balancing - Ingress and Service</a></li> <li><a href="#leader-election">Leader Election</a></li> <li><a href="#pod-disruption-budget-pdb">Pod Disruption Budget (PDB)</a></li> <li><a href="#anti-affinity-preference">Anti-Affinity Preference</a></li> <li><a href="#autoscaling">Autoscaling</a> <ul> <li><a href="#vertical-autoscaling">Vertical Autoscaling</a></li> <li><a href="#horizontal-autoscaling">Horizontal Autoscaling</a></li> </ul> </li> </ul> </li> <li><a href="#monitoring-and-alerts">Monitoring and Alerts</a> <ul> <li><a href="#api-uptime-and-latency">API Uptime and Latency</a></li> <li><a href="#resource-usage---cpu-ram-disk-io">Resource Usage - CPU, RAM, Disk, I/O</a></li> <li><a href="#unavailable-pods">Unavailable Pods</a></li> </ul> </li> </ul> </div> <p><a href="https://kubernetes.io/docs/concepts/workloads/pods/pod/">Pods</a> in Kubernetes are the smallest orchestration unit and are ephemeral by definition:</p> <ul> <li>Deployment/StatefulSet/DaemonSet/ReplicaSet updates or patches</li> <li>Nodepool downscaling (compaction) or upgrades (cordoned and drained)</li> </ul> <p>Kubernetes simplifies scheduling and orchestration but there are extra hurdles to develop and operate applications with high availability. I list some action items for HA and explain the motivations behind them.</p> <h3 id="pod">Pod</h3> <h4 id="graceful-termination">Graceful Termination</h4> <p>When a Pod is evicted,</p> <ul> <li>Pod containers each receive a <code class="language-plaintext highlighter-rouge">SIGTERM</code>.</li> <li>Eviction controller waits <code class="language-plaintext highlighter-rouge">terminationGracePeriodSeconds</code> (default 30 seconds)</li> <li>Pod containers each receive a <code class="language-plaintext highlighter-rouge">SIGKILL</code></li> <li>Eviction controller waits for all containers exit</li> </ul> <p>Handle the termination signal gracefully because your application may still be serving in-flight requests or need to clean up persistent storage before exit.</p> <h4 id="health-checks">Health Checks</h4> <p>Health checks are important to ensure that unhealthy—irresponsive, about-to-be-killed, or initializing-and-unready—Pods are not selected in the working set. Health checks can be in forms of <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/#define-a-liveness-command">shell commands</a>, <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/#define-a-liveness-http-request">HTTP probes</a>, or <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/#define-a-tcp-liveness-probe">TCP probes</a>.</p> <h5 id="readiness-probes">Readiness Probes</h5> <p>A Pod will only start serving traffic after its <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/#define-readiness-probes">Readiness probe</a> succeeded. For example, your web app should establish a connection to your favorite database before serving its API.</p> <h5 id="liveness-probes">Liveness Probes</h5> <p>Many applications running for long periods of time eventually transition to broken states, and cannot recover except by being restarted. Kubernetes provides <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/#define-a-liveness-command">Liveness probes</a> to detect and remedy such situations.</p> <h5 id="startup-probes">Startup Probes</h5> <p><a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/#define-startup-probes">Startup Probes</a> resembles Liveness probes but are intended for slow-initialization applications. Without Startup probes, one may use longer Liveness probes for slow-start applications, but doing so compromises the fast response to deadlocks that motivate Liveness probes in the first place.</p> <h4 id="priority-class">Priority Class</h4> <p>If a Pod cannot be scheduled, the scheduler tries to preempt (evict) lower <a href="https://kubernetes.io/docs/concepts/configuration/pod-priority-preemption/">priority</a> Pods to make scheduling of the pending Pod possible. Run your mission-critical Pods on high priority. For example, logging, monitoring, backup, and a subset of application services (depending on business logic) should be of high priority, but batched and cron jobs may be not.</p> <h4 id="resource-requirements-and-quotas">Resource Requirements and Quotas</h4> <p>Pod resources are CPU counts, memory space, and ephemeral storage size. Resource requirements include requests (minimum needed to run) and limits (maximum allowed). If you configure the same value for requests and limits, your Pods are of <code class="language-plaintext highlighter-rouge">Guaranteed</code> (highest) <a href="https://kubernetes.io/docs/tasks/configure-pod-container/quality-service-pod/">Quality of Service</a> (QoS) Classes. If the node is under memory pressure, burstable or best effort Pods are killed and rescheduled first.</p> <p>However, depending on your node size, choose sensible resource requirements. If your node has 64 vCPU, asking for 60 is just not cloud-native.</p> <h3 id="replicated-pods">Replicated Pods</h3> <h4 id="load-balancing---ingress-and-service">Load Balancing - Ingress and Service</h4> <p>Put your replicated Pods behind a load balancer to ensure your HTTP/TCP/UDP application remains accessible when Pod health or membership changes. Such a load balancer could be an Ingress or a Service, depending on whether you want this service to be accessible only in the cluster network or your company VPC or the public internet.</p> <h4 id="leader-election">Leader Election</h4> <p>Perhaps not all of the replicated Pods should be considered active. For example, a Kubernetes controller on CRDs should logically be just one instance. Leader election allows such an application to still be replicated while preserving the single-instance abstraction.</p> <h4 id="pod-disruption-budget-pdb">Pod Disruption Budget (PDB)</h4> <p>A <a href="https://kubernetes.io/docs/concepts/workloads/pods/disruptions/">PDB</a> limits the number Pods of a replicated application that are down simultaneously from voluntary disruptions. For example, a quorum-based application would like to ensure that the number of replicas running is never brought below the number needed for a quorum.</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">policy/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">PodDisruptionBudget</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">zk-pdb</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">minAvailable</span><span class="pi">:</span> <span class="m">2</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">zookeeper</span>
</pre></td></tr></tbody></table></code></pre></div></div> <h4 id="anti-affinity-preference">Anti-Affinity Preference</h4> <p><a href="https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#affinity-and-anti-affinity">Anti-Affinity Preference</a> allow replicated Pods to be scheduled to different nodes. Without such preference, a single node failure could knock out multiple Pods if they happen to be scheduled on the same node, which is possible since scheduling is done by resource allocation.</p> <h4 id="autoscaling">Autoscaling</h4> <p><a href="https://medium.com/magalix/kubernetes-autoscaling-101-cluster-autoscaler-horizontal-pod-autoscaler-and-vertical-pod-2a441d9ad231">Autoscaling</a> allows the service backends to adjust to the request rate and to mitigate overloading.</p> <h5 id="vertical-autoscaling">Vertical Autoscaling</h5> <p><a href="https://cloud.google.com/kubernetes-engine/docs/concepts/verticalpodautoscaler">Vertical autoscaling</a> modifies the resources allocated to your Pods dynamically.</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">autoscaling.k8s.io/v1beta2</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">VerticalPodAutoscaler</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">my-vpa</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">targetRef</span><span class="pi">:</span>
    <span class="na">apiVersion</span><span class="pi">:</span> <span class="s2">"</span><span class="s">extensions/v1beta1"</span>
    <span class="na">kind</span><span class="pi">:</span>       <span class="s">Deployment</span>
    <span class="na">name</span><span class="pi">:</span>       <span class="s">my-deployment</span>
  <span class="na">updatePolicy</span><span class="pi">:</span>
    <span class="na">updateMode</span><span class="pi">:</span> <span class="s">Initial</span>
</pre></td></tr></tbody></table></code></pre></div></div> <p>If you need to limit the number of concurrent pod restarts, use a Pod Disruption Budget. Be extra careful if you are using ingress solution from your cloud vendor, such as <a href="https://cloud.google.com/load-balancing/">GCLB</a>, it may take minutes to update backend routes which can cause routing failure and downtime when combined with frequent rescheduling.</p> <h5 id="horizontal-autoscaling">Horizontal Autoscaling</h5> <p>Horizontal autoscaling dynamically modifies the replica count of a Deployment. By default, the HPA only supports scaling based on CPU or memory usage, which are often suboptimal for request-based or queue-based workloads. HPA supports autoscaling based on custom metrics, but doing so requires elevated permissions to register a <a href="https://github.com/kubernetes-incubator/custom-metrics-apiserver">Custom Metrics Adapter</a> to serve a cluster-level API endpoint, which may not be an option if you are running in a multi-tenant environment.</p> <h3 id="monitoring-and-alerts">Monitoring and Alerts</h3> <h4 id="api-uptime-and-latency">API Uptime and Latency</h4> <p>This is probably the key KPI that your customers care about. Visibility on the API uptime and latency allows quick responses to incidents. Managed solutions include Runscope, Pingdom, DataDog, UpDown.io, StackDriver, etc. It is also important to alert on these metrics to PagerDuty, Slack, or Email.</p> <h4 id="resource-usage---cpu-ram-disk-io">Resource Usage - CPU, RAM, Disk, I/O</h4> <p>Eccentric resource usage is usually a precursor for outages. Usually, developers or the language runtime will embed in the application Prometheus endpoints for scraping these metrics. DataDog agents make collecting them easy.</p> <h4 id="unavailable-pods">Unavailable Pods</h4> <p>You could have the right configurations for HA but still have unschedulable Pods—image pull unsuccessful, or container stuck in crash loop, or node auto scaler has reached max, etc.</p> </div> <p> <small> <span class="post-date"><time class="post-date" datetime="2019-12-29">29 Dec 2019</time></span> </small> </p> <div class="after-post-cats"> <ul class="tags mb-4"> <li> <a class="smoothscroll" href="/categories#kubernetes">kubernetes</a> </li> <li> <a class="smoothscroll" href="/categories#operation">operation</a> </li> <li> <a class="smoothscroll" href="/categories#web">web</a> </li> </ul> </div> <div class="after-post-tags"> <ul class="tags"> </ul> </div> <div class="row PageNavigation d-flex justify-content-between font-weight-bold"> <a class="prev d-block col-md-6" href="/advices/"> &laquo; Advices I wish I got at the start of my career</a> <a class="next d-block col-md-6 text-lg-right" href="/go-opts/">Parameters with Defaults in Go: Functional Options &raquo; </a> <div class="clearfix"></div> </div> </div> </div> </div> </div> <div class="alertbar"> <div class="container text-center"> <span><img src="/assets/images/logo.png" alt="Charles Xu" height="32" width="32"> &nbsp; Never miss a <b>story</b> from me, subscribe to my newsletter</span> <form action="https://gmail.us5.list-manage.com/subscribe/post?u=b3d456844a3860642cd584c1b&amp;id=3f0c5c8bcd" method="post" name="mc-embedded-subscribe-form" class="wj-contact-form validate" target="_blank" novalidate> <div class="mc-field-group"> <input type="email" placeholder="Email" name="EMAIL" class="required email" id="mce-EMAIL" autocomplete="on" required> <input type="submit" value="Subscribe" name="subscribe" class="heart"> </div> </form> </div> </div> </div> <div class="jumbotron fortags"> <div class="d-md-flex h-100"> <div class="col-md-4 transpdark align-self-center text-center h-100"> <div class="d-md-flex align-items-center justify-content-center h-100"> <h2 class="d-md-block align-self-center py-1 font-weight-light">Explore <span class="d-none d-md-inline">→</span></h2> </div> </div> <div class="col-md-8 p-5 align-self-center text-center"> <a class="mt-1 mb-1" href="/categories#git">git (3)</a> <a class="mt-1 mb-1" href="/categories#web">web (9)</a> <a class="mt-1 mb-1" href="/categories#microservices">microservices (8)</a> <a class="mt-1 mb-1" href="/categories#distributed-systems">distributed systems (6)</a> <a class="mt-1 mb-1" href="/categories#signal-processing">signal processing (1)</a> <a class="mt-1 mb-1" href="/categories#networking">networking (11)</a> <a class="mt-1 mb-1" href="/categories#istio">istio (4)</a> <a class="mt-1 mb-1" href="/categories#security">security (1)</a> <a class="mt-1 mb-1" href="/categories#docker">docker (2)</a> <a class="mt-1 mb-1" href="/categories#kubernetes">kubernetes (9)</a> <a class="mt-1 mb-1" href="/categories#operation">operation (4)</a> <a class="mt-1 mb-1" href="/categories#career">career (5)</a> <a class="mt-1 mb-1" href="/categories#go">go (1)</a> <a class="mt-1 mb-1" href="/categories#cloud">cloud (4)</a> <a class="mt-1 mb-1" href="/categories#investment">investment (1)</a> <a class="mt-1 mb-1" href="/categories#startup">startup (4)</a> <a class="mt-1 mb-1" href="/categories#oss">oss (1)</a> </div> </div> </div> <footer class="footer"> <div class="container"> <div class="row"> <div class="col-md-6 col-sm-6 text-center text-lg-left" style="margin-bottom: 10px;"> Copyright © 2016-2023 Charles Xu </div> </div> </div> </footer> </div> <script src="/assets/js/popper.min.js"></script> <script src="/assets/js/bootstrap.min.js"></script> <script src="/assets/js/mediumish.js"></script> <script src="/assets/js/lazyload.js"></script> <script src="/assets/js/ie10-viewport-bug-workaround.js"></script> <link href="/assets/css/screen.css" rel="stylesheet"> <link href="/assets/css/main.css" rel="stylesheet"> </body> </html>