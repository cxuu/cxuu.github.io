<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <link rel="icon" href="/assets/images/logo.png"> <title>Lessons from Scaling GKE: L4 ILB Tops at 250 Nodes | Charles Xu</title> <title>Lessons from Scaling GKE: L4 ILB Tops at 250 Nodes | Charles Xu</title> <meta name="generator" content="Jekyll v4.2.0"/> <meta property="og:title" content="Lessons from Scaling GKE: L4 ILB Tops at 250 Nodes"/> <meta property="og:locale" content="en_US"/> <meta name="description" content="My team at Cruise operates tens of Kubernetes clusters with 10,000s cores and 100s of TB of RAM. Since migration to GCP, we have hit several interesting scaling issues. One of those caused cluster-wide ingress outage for all tenants. In this post, I will revisit the symptom, root cause, and mitigations for this incident. We struggled so you do not have to."/> <meta property="og:description" content="My team at Cruise operates tens of Kubernetes clusters with 10,000s cores and 100s of TB of RAM. Since migration to GCP, we have hit several interesting scaling issues. One of those caused cluster-wide ingress outage for all tenants. In this post, I will revisit the symptom, root cause, and mitigations for this incident. We struggled so you do not have to."/> <meta property="og:site_name" content="Charles Xu"/> <meta property="og:image" content="/assets/images/gke-scaling/cover.jpg"/> <meta property="og:type" content="article"/> <meta property="article:published_time" content="2020-03-20T00:00:00-05:00"/> <meta name="twitter:card" content="summary_large_image"/> <meta property="twitter:image" content="/assets/images/gke-scaling/cover.jpg"/> <meta property="twitter:title" content="Lessons from Scaling GKE: L4 ILB Tops at 250 Nodes"/> <script type="application/ld+json">
{"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"/assets/images/logo.png"}},"url":"/gke-scaling/","mainEntityOfPage":{"@type":"WebPage","@id":"/gke-scaling/"},"image":"/assets/images/gke-scaling/cover.jpg","headline":"Lessons from Scaling GKE: L4 ILB Tops at 250 Nodes","@type":"BlogPosting","dateModified":"2020-03-20T00:00:00-05:00","description":"My team at Cruise operates tens of Kubernetes clusters with 10,000s cores and 100s of TB of RAM. Since migration to GCP, we have hit several interesting scaling issues. One of those caused cluster-wide ingress outage for all tenants. In this post, I will revisit the symptom, root cause, and mitigations for this incident. We struggled so you do not have to.","datePublished":"2020-03-20T00:00:00-05:00","@context":"https://schema.org"}</script> <link href="/assets/css/bootstrap.min.css" rel="stylesheet"> <script src="/assets/js/jquery.min.js"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-8CYZ0N0EWJ"></script> <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-8CYZ0N0EWJ");</script> <script>!function(e,t,a,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=t.createElement(a),s=t.getElementsByTagName(a)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-151349369-1","auto"),ga("send","pageview");</script> <script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "5b6e3d4ee3274005a2d3321f9bb0516c"}'></script> </head> <body class="layout-post"> <noscript id="deferred-styles"> <link href="/assets/css/fontawesome.css" rel="stylesheet"> <link href="/assets/css/google-fonts.css" rel="stylesheet"> </noscript> <nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top mediumnavigation nav-down"> <div class="container pr-0"> <a class="navbar-brand" href="/"> <img src="/assets/images/logo.png" alt="Charles Xu" height="32" width="32"> </a> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarMediumish" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <div class="collapse navbar-collapse" id="navbarMediumish"> <ul class="navbar-nav ml-auto"> <li class="nav-item"> <a class="nav-link" href="/about">About</a> </li> <li class="nav-item"> <a class="nav-link" href="/bookshelf">Bookshelf</a> </li> <li class="nav-item"> <a class="nav-link" href="/inspirations">Inspirations</a> </li> <li class="nav-item"> <a class="nav-link" href="/wiki">Wiki</a> </li> <li class="nav-item"> <a class="nav-link" href="/">Blog</a> </li> <script src="/assets/js/lunr.js"></script> <style>.lunrsearchresult .title{color:#d9230f}.lunrsearchresult .url{color:silver}.lunrsearchresult a{display:block;color:#777}.lunrsearchresult a:hover,.lunrsearchresult a:focus{text-decoration:none}.lunrsearchresult a:hover .title{text-decoration:underline}</style> <div style="width: 14px; height: 10px;"></div> <form class="bd-search" onSubmit="return lunr_search(document.getElementById('lunrsearch').value);"> <input type="text" class="form-control text-small launch-modal-search" id="lunrsearch" name="q" maxlength="255" value="" placeholder="Type and enter..."/> </form> <div id="lunrsearchresults"> <ul></ul> </div> <script src="/assets/js/lunrsearchengine.js"></script> </ul> </div> </div> </nav> <div class="site-content"> <div class="container"> <div class="mainheading"> <h1 class="sitetitle">Charles Xu</h1> <p class="lead"> Essays, books, wiki on technologies, career, markets, and more. </p> </div> <div id="loading"> <div id="loading-image" class="lds-ellipsis"><div></div><div></div><div></div><div></div></div> </div> <script>$(window).on("load",function(){$("#loading").hide()});</script> <div class="main-content"> <div class="container"> <div class="row"> <div class="col-md-2 pl-0"> <div class="share sticky-top sticky-top-offset"> <p> Share </p> <ul> <li class="ml-1 mr-1"> <a target="_blank" href="https://twitter.com/intent/tweet?text=Lessons from Scaling GKE: L4 ILB Tops at 250 Nodes&url=charlesxu.io/gke-scaling/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;"> <i class="fab fa-twitter"></i> </a> </li> <li class="ml-1 mr-1"> <a target="_blank" href="https://facebook.com/sharer.php?u=charlesxu.io/gke-scaling/" onclick="window.open(this.href, 'facebook-share', 'width=550,height=435');return false;"> <i class="fab fa-facebook-f"></i> </a> </li> <li class="ml-1 mr-1"> <a target="_blank" href="https://www.linkedin.com/shareArticle?mini=true&url=charlesxu.io/gke-scaling/" onclick="window.open(this.href, 'width=550,height=435');return false;"> <i class="fab fa-linkedin-in"></i> </a> </li> </ul> <div class="sep"> </div> <ul> <li> <a class="small smoothscroll" href="#disqus_thread"></a> </li> </ul> </div> </div> <div class="col-md-8 flex-first flex-md-unordered"> <div class="mainheading"> <h1 class="posttitle">Lessons from Scaling GKE: L4 ILB Tops at 250 Nodes</h1> </div> <img class="featured-image img-fluid lazyimg" style="min-width: 100%" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAMAAAACCAQAAAA3fa6RAAAADklEQVR42mNkAANGCAUAACMAA2w/AMgAAAAASUVORK5CYII=" data-src="/assets/images/gke-scaling/cover.jpg" alt="Lessons from Scaling GKE: L4 ILB Tops at 250 Nodes"> <div class="article-post"> <div class="toc mt-4 mb-4 lead"> <h3 style="color: #9c9c9c">Table of Contents</h3> <ul> <li><a href="#architecture-private-ingress-with-ilb-and-nginx-controller">Architecture: Private Ingress with ILB and Nginx Controller</a></li> <li><a href="#symptom">Symptom</a></li> <li><a href="#root-causes">Root Causes</a></li> <li><a href="#mitigations">Mitigations</a> <ul> <li><a href="#immediate">Immediate</a></li> <li><a href="#short-term">Short-term</a></li> <li><a href="#long-term">Long-term</a></li> </ul> </li> </ul> </div> <p>My team at Cruise operates tens of Kubernetes clusters with 10,000s cores and 100s of TB of RAM. Since migration to GCP, we have hit several interesting scaling issues. One of those caused cluster-wide ingress outage for all tenants. In this post, I will revisit the symptom, root cause, and mitigations for this incident. We struggled so you do not have to.</p> <h3 id="architecture-private-ingress-with-ilb-and-nginx-controller">Architecture: Private Ingress with ILB and Nginx Controller</h3> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre>            Client
              |
              | L3/L4
              |
              v
Internal TCP/UDP Load Balancer
              |
              | L7 HTTP
              |
--------------+------------------
|             |                 |
|             v                 |
|   Nginx Ingress Controllers   |
|             |                 |
|             | L7 HTTP         |
|             |                 |
|             v                 |
|            Pods               |
|GKE                            |
---------------------------------
</pre></td></tr></tbody></table></code></pre></div></div> <h3 id="symptom">Symptom</h3> <p>The Internal Load Balancer (ILB) used for private ingress in the cluster stopped responding to connections. New connection requests hung (e.g. curl &amp; traceroute) except for requests originated from within the cluster.</p> <h3 id="root-causes">Root Causes</h3> <ol> <li> <p>Currently, L4 ILB only supports at most 250 backends (<a href="https://cloud.google.com/load-balancing/docs/quotas#backend_services">source</a>). The Kubernetes cloud provider that controls ILB creation sets all Kubernetes nodes in the cluster as ILB backends. As a result, the maximum number of GKE nodes that gets traffic from the ILB is 250. When more than 250 nodes present in the GKE cluster, ILB will deterministically (using node ID) select a subset of 250 backends for healthcheck.</p> </li> <li> <p>The Nginx controllers are deployed in the cluster as well. They use <code class="language-plaintext highlighter-rouge">externalTrafficPolicy: local</code> to bypass iptables and sends traffic directly to any pods located on the host. From the perspective of the ILB every node that has the destination pod will be healthy and ones that do not will be permanently unhealthy.</p> </li> <li> <p>A tenant workload scale-up caused the number of nodes in the cluster to autoscale above 250. None of the nodes that Nginx resides on were selected by the ILB. As a result, the ILB considered all nodes in the subset as unhealthy. When all ILB backends are unhealthy, no traffic through the ILB will be passed to the cluster.</p> </li> </ol> <h3 id="mitigations">Mitigations</h3> <h4 id="immediate">Immediate</h4> <p>In order to immediately restore cluster ingress service, another ILB was manually created using the cluster’s well-known ingress IP address. This ILB was configured to point to a couple instance groups such that the number of backing nodes did not exceed the limit of 250.</p> <h4 id="short-term">Short-term</h4> <p>One could deploy a cluster with larger nodes (vertical scaling) in the hope that the total number of nodes will be within 250.</p> <p>Alternatively, one may use <code class="language-plaintext highlighter-rouge">externalTrafficPolicy: cluster</code> so Nginx service will use kube-proxy/iptables to load balance traffic to the correct pod(s) regardless of which node traffic lands on in the cluster. The downside of this solution is that</p> <ul> <li>Extra latency. When the ILB is sending traffic to the 250-node subset, traffic will go through a second hop to get to the destination pod IPs.</li> <li>Less secure, because it requires opening firewalls for port 80/443 on all nodes.</li> <li>The client source IP is not preserved, because of the iptables hop.</li> </ul> <h4 id="long-term">Long-term</h4> <p>Move Nginx controllers out of the cluster and into a GCE instance group, so ILB healthcheck will be done properly.</p> </div> <p> <small> <span class="post-date"><time class="post-date" datetime="2020-03-20">20 Mar 2020</time></span> </small> </p> <div class="after-post-cats"> <ul class="tags mb-4"> <li> <a class="smoothscroll" href="/categories#kubernetes">kubernetes</a> </li> </ul> </div> <div class="after-post-tags"> <ul class="tags"> </ul> </div> <div class="row PageNavigation d-flex justify-content-between font-weight-bold"> <a class="prev d-block col-md-6" href="/go-opts/"> &laquo; Parameters with Defaults in Go: Functional Options</a> <a class="next d-block col-md-6 text-lg-right" href="/dns-udp/">DNS, UDP, IP Anycast, and All That &raquo; </a> <div class="clearfix"></div> </div> </div> </div> </div> </div> <div class="alertbar"> <div class="container text-center"> <span><img src="/assets/images/logo.png" alt="Charles Xu" height="32" width="32"> &nbsp; Never miss a <b>story</b> from me, subscribe to my newsletter</span> <form action="https://gmail.us5.list-manage.com/subscribe/post?u=b3d456844a3860642cd584c1b&amp;id=3f0c5c8bcd" method="post" name="mc-embedded-subscribe-form" class="wj-contact-form validate" target="_blank" novalidate> <div class="mc-field-group"> <input type="email" placeholder="Email" name="EMAIL" class="required email" id="mce-EMAIL" autocomplete="on" required> <input type="submit" value="Subscribe" name="subscribe" class="heart"> </div> </form> </div> </div> </div> <div class="jumbotron fortags"> <div class="d-md-flex h-100"> <div class="col-md-4 transpdark align-self-center text-center h-100"> <div class="d-md-flex align-items-center justify-content-center h-100"> <h2 class="d-md-block align-self-center py-1 font-weight-light">Explore <span class="d-none d-md-inline">→</span></h2> </div> </div> <div class="col-md-8 p-5 align-self-center text-center"> <a class="mt-1 mb-1" href="/categories#git">git (3)</a> <a class="mt-1 mb-1" href="/categories#web">web (6)</a> <a class="mt-1 mb-1" href="/categories#microservices">microservices (3)</a> <a class="mt-1 mb-1" href="/categories#distributed-systems">distributed systems (4)</a> <a class="mt-1 mb-1" href="/categories#signal-processing">signal processing (1)</a> <a class="mt-1 mb-1" href="/categories#istio">istio (3)</a> <a class="mt-1 mb-1" href="/categories#security">security (1)</a> <a class="mt-1 mb-1" href="/categories#docker">docker (2)</a> <a class="mt-1 mb-1" href="/categories#interview">interview (2)</a> <a class="mt-1 mb-1" href="/categories#kubernetes">kubernetes (5)</a> <a class="mt-1 mb-1" href="/categories#operation">operation (2)</a> <a class="mt-1 mb-1" href="/categories#networking">networking (3)</a> <a class="mt-1 mb-1" href="/categories#career">career (5)</a> <a class="mt-1 mb-1" href="/categories#go">go (1)</a> <a class="mt-1 mb-1" href="/categories#shell">shell (1)</a> <a class="mt-1 mb-1" href="/categories#investment">investment (1)</a> <a class="mt-1 mb-1" href="/categories#law">law (1)</a> <a class="mt-1 mb-1" href="/categories#startup">startup (4)</a> <a class="mt-1 mb-1" href="/categories#accounting">accounting (1)</a> <a class="mt-1 mb-1" href="/categories#oss">oss (1)</a> <a class="mt-1 mb-1" href="/categories#sales">sales (1)</a> <a class="mt-1 mb-1" href="/categories#advice">advice (1)</a> </div> </div> </div> <footer class="footer"> <div class="container"> <div class="row"> <div class="col-md-6 col-sm-6 text-center text-lg-left" style="margin-bottom: 10px;"> Copyright © 2016-2023 Charles Xu </div> </div> </div> </footer> </div> <script src="/assets/js/popper.min.js"></script> <script src="/assets/js/bootstrap.min.js"></script> <script src="/assets/js/mediumish.js"></script> <script src="/assets/js/lazyload.js"></script> <script src="/assets/js/ie10-viewport-bug-workaround.js"></script> <link href="/assets/css/screen.css" rel="stylesheet"> <link href="/assets/css/main.css" rel="stylesheet"> </body> </html>