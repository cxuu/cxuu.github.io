<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <link rel="icon" href="/assets/images/logo.png"> <title>The Good, Bad, and Ugly: Istio for Short-lived Pods | Charles Xu</title> <title>The Good, Bad, and Ugly: Istio for Short-lived Pods | Charles Xu</title> <meta name="generator" content="Jekyll v4.2.0"/> <meta property="og:title" content="The Good, Bad, and Ugly: Istio for Short-lived Pods"/> <meta property="og:locale" content="en_US"/> <meta name="description" content="Kubernetes does not differentiate sidecars and application containers in a Pod. Hence, enabling Istio for short-running workloads imposes additional challenges to the conventional approach of injecting an Envoy sidecar to the istio-enabled Pod."/> <meta property="og:description" content="Kubernetes does not differentiate sidecars and application containers in a Pod. Hence, enabling Istio for short-running workloads imposes additional challenges to the conventional approach of injecting an Envoy sidecar to the istio-enabled Pod."/> <meta property="og:site_name" content="Charles Xu"/> <meta property="og:image" content="/assets/images/istio-short/cover2.jpg"/> <meta property="og:type" content="article"/> <meta property="article:published_time" content="2020-04-26T00:00:00-05:00"/> <meta name="twitter:card" content="summary_large_image"/> <meta property="twitter:image" content="/assets/images/istio-short/cover2.jpg"/> <meta property="twitter:title" content="The Good, Bad, and Ugly: Istio for Short-lived Pods"/> <script type="application/ld+json">
{"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"/assets/images/logo.png"}},"url":"/istio-short/","mainEntityOfPage":{"@type":"WebPage","@id":"/istio-short/"},"image":"/assets/images/istio-short/cover2.jpg","headline":"The Good, Bad, and Ugly: Istio for Short-lived Pods","@type":"BlogPosting","dateModified":"2020-04-26T00:00:00-05:00","description":"Kubernetes does not differentiate sidecars and application containers in a Pod. Hence, enabling Istio for short-running workloads imposes additional challenges to the conventional approach of injecting an Envoy sidecar to the istio-enabled Pod.","datePublished":"2020-04-26T00:00:00-05:00","@context":"https://schema.org"}</script> <link href="/assets/css/bootstrap.min.css" rel="stylesheet"> <script src="/assets/js/jquery.min.js"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-8CYZ0N0EWJ"></script> <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-8CYZ0N0EWJ");</script> <script>!function(e,t,a,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=t.createElement(a),s=t.getElementsByTagName(a)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-151349369-1","auto"),ga("send","pageview");</script> <script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "5b6e3d4ee3274005a2d3321f9bb0516c"}'></script> </head> <body class="layout-post"> <noscript id="deferred-styles"> <link href="/assets/css/fontawesome.css" rel="stylesheet"> <link href="/assets/css/google-fonts.css" rel="stylesheet"> </noscript> <nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top mediumnavigation nav-down"> <div class="container pr-0"> <a class="navbar-brand" href="/"> <img src="/assets/images/logo.png" alt="Charles Xu" height="32" width="32"> </a> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarMediumish" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <div class="collapse navbar-collapse" id="navbarMediumish"> <ul class="navbar-nav ml-auto"> <li class="nav-item"> <a class="nav-link" href="/about">About</a> </li> <li class="nav-item"> <a class="nav-link" href="/bookshelf">Bookshelf</a> </li> <li class="nav-item"> <a class="nav-link" href="/inspirations">Inspirations</a> </li> <li class="nav-item"> <a class="nav-link" href="/wiki">Wiki</a> </li> <li class="nav-item"> <a class="nav-link" href="/">Blog</a> </li> <script src="/assets/js/lunr.js"></script> <style>.lunrsearchresult .title{color:#d9230f}.lunrsearchresult .url{color:silver}.lunrsearchresult a{display:block;color:#777}.lunrsearchresult a:hover,.lunrsearchresult a:focus{text-decoration:none}.lunrsearchresult a:hover .title{text-decoration:underline}</style> <div style="width: 14px; height: 10px;"></div> <form class="bd-search" onSubmit="return lunr_search(document.getElementById('lunrsearch').value);"> <input type="text" class="form-control text-small launch-modal-search" id="lunrsearch" name="q" maxlength="255" value="" placeholder="Type and enter..."/> </form> <div id="lunrsearchresults"> <ul></ul> </div> <script src="/assets/js/lunrsearchengine.js"></script> </ul> </div> </div> </nav> <div class="site-content"> <div class="container"> <div class="mainheading"> <h1 class="sitetitle">Charles Xu</h1> <p class="lead"> Essays, books, wiki on technologies, career, markets, and more. </p> </div> <div id="loading"> <div id="loading-image" class="lds-ellipsis"><div></div><div></div><div></div><div></div></div> </div> <script>$(window).on("load",function(){$("#loading").hide()});</script> <div class="main-content"> <div class="container"> <div class="row"> <div class="col-md-2 pl-0"> <div class="share sticky-top sticky-top-offset"> <p> Share </p> <ul> <li class="ml-1 mr-1"> <a target="_blank" href="https://twitter.com/intent/tweet?text=The Good, Bad, and Ugly: Istio for Short-lived Pods&url=charlesxu.io/istio-short/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;"> <i class="fab fa-twitter"></i> </a> </li> <li class="ml-1 mr-1"> <a target="_blank" href="https://facebook.com/sharer.php?u=charlesxu.io/istio-short/" onclick="window.open(this.href, 'facebook-share', 'width=550,height=435');return false;"> <i class="fab fa-facebook-f"></i> </a> </li> <li class="ml-1 mr-1"> <a target="_blank" href="https://www.linkedin.com/shareArticle?mini=true&url=charlesxu.io/istio-short/" onclick="window.open(this.href, 'width=550,height=435');return false;"> <i class="fab fa-linkedin-in"></i> </a> </li> </ul> <div class="sep"> </div> <ul> <li> <a class="small smoothscroll" href="#disqus_thread"></a> </li> </ul> </div> </div> <div class="col-md-8 flex-first flex-md-unordered"> <div class="mainheading"> <h1 class="posttitle">The Good, Bad, and Ugly: Istio for Short-lived Pods</h1> </div> <img class="featured-image img-fluid lazyimg" style="min-width: 100%" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAMAAAACCAQAAAA3fa6RAAAADklEQVR42mNkAANGCAUAACMAA2w/AMgAAAAASUVORK5CYII=" data-src="/assets/images/istio-short/cover2.jpg" alt="The Good, Bad, and Ugly: Istio for Short-lived Pods"> <div class="article-post"> <p>Kubernetes does not differentiate sidecars and application containers in a Pod. Hence, enabling Istio for short-running workloads imposes additional challenges to the conventional approach of injecting an Envoy sidecar to the istio-enabled Pod.</p> <ul> <li>The proxy sidecar is long-running and prevents the Pod from finishing even after the application container has completed.</li> <li>We cannot ensure the proxy to be running and healthy before the application container starts. Without Istio proxy, requests to downstream services may fail if service authentication is enabled, and thus the app container would fail its health check, causing the Pod to be recreated. The pod may be stuck in a crash loop for a while.</li> </ul> <h3 id="straw-man-attempts">Straw-man attempts</h3> <p>At first sight, it seems the <code class="language-plaintext highlighter-rouge">initContainers</code> in <code class="language-plaintext highlighter-rouge">Pod</code> is exactly what we wanted. After all, don’t <code class="language-plaintext highlighter-rouge">initContainers</code> always run before <code class="language-plaintext highlighter-rouge">containers</code> in <code class="language-plaintext highlighter-rouge">Pod</code>? Yet, no <code class="language-plaintext highlighter-rouge">containers</code> start until all <code class="language-plaintext highlighter-rouge">initContainers</code> have exited successfully. If we run Istio proxy in <code class="language-plaintext highlighter-rouge">initContainers</code>, then we have to kill it manually before the app container could start, which requires the proxy to connect to the service mesh.</p> <p>Some popular <a href="https://github.com/istio/istio/issues/11130">mitigation</a> I have seen is to change the entrypoint of the app container to wait a few seconds before executing the app binary. But how long of a wait is enough? Starting too soon risks proxy not healthy, but starting too late is a waste of time and resources. Scheduling is never deterministic. Worse, one will have to update the Pod spec themselves, which is not amenable to all the workloads in the cluster.</p> <h3 id="an-automated-and-robust-solution">An Automated and Robust Solution</h3> <h4 id="start-pod-mutating-webhook--command-overwrites">Start Pod: Mutating Webhook + Command Overwrites</h4> <p>You may build a binary (say, <code class="language-plaintext highlighter-rouge">valet</code>) that polls the <code class="language-plaintext highlighter-rouge">/ready</code> endpoint of the proxy, and then exec the app binary afterwards. We can use the mutating webhook from Kubernetes to automatically rewrite the container command to include <code class="language-plaintext highlighter-rouge">valet</code>. The <code class="language-plaintext highlighter-rouge">valet</code> binary can be downloaded using a init container and copied to the app container using a shared volume. The following Kubernetes manifest shows this approach.</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre></td><td class="rouge-code"><pre><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">batch/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Job</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">short-lived</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">completions</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">parallelism</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">short-lived</span>
      <span class="na">annotations</span><span class="pi">:</span>
        <span class="s">sidecar.istio.io/inject</span><span class="pi">:</span> <span class="s2">"</span><span class="s">true"</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">short-lived</span>
        <span class="s">myapp.com/valet</span><span class="pi">:</span> <span class="s2">"</span><span class="s">true"</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">initContainers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">valet-init</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">myapp/valet:latest</span>
        <span class="na">command</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">/bin/sh</span>
        <span class="na">args</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">-c</span>
        <span class="pi">-</span> <span class="s">cp /valet /shared/valet</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/shared</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">shared</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">short-lived</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">myapp:latest</span>
        <span class="na">command</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s2">"</span><span class="s">/shared/valet"</span>
        <span class="pi">-</span> <span class="s2">"</span><span class="s">myapp"</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">shared</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/shared</span>
      <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">shared</span>
        <span class="na">emptyDir</span><span class="pi">:</span> <span class="pi">{}</span>
</pre></td></tr></tbody></table></code></pre></div></div> <h4 id="finish-pod-pod-exec--kill-proxy">Finish Pod: Pod Exec + Kill Proxy</h4> <p>The <code class="language-plaintext highlighter-rouge">valet</code> binary also supports a <code class="language-plaintext highlighter-rouge">-stop-proxy</code> flag, which will stop Envoy proxy by calling the <code class="language-plaintext highlighter-rouge">/quitquitquit</code> endpoint on the pilot-agent. In addition to that, the valet controller will be watching all the pods that are labeled as <code class="language-plaintext highlighter-rouge">myapp.com/valet: "true"</code>, and it will issue a <code class="language-plaintext highlighter-rouge">valet -stop-proxy</code> command when the short-lived containers are all completed. It will essentially be the below call.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>kubectl <span class="nb">exec</span> <span class="nt">-it</span> <span class="nv">$pod</span> <span class="nt">-c</span> short-lived <span class="nt">--</span> /shared/valet <span class="nt">-stop-proxy</span>
</pre></td></tr></tbody></table></code></pre></div></div> </div> <p> <small> <span class="post-date"><time class="post-date" datetime="2020-04-26">26 Apr 2020</time></span> </small> </p> <div class="after-post-cats"> <ul class="tags mb-4"> <li> <a class="smoothscroll" href="/categories#istio">istio</a> </li> </ul> </div> <div class="after-post-tags"> <ul class="tags"> </ul> </div> <div class="row PageNavigation d-flex justify-content-between font-weight-bold"> <a class="prev d-block col-md-6" href="/dns-udp/"> &laquo; DNS, UDP, IP Anycast, and All That</a> <a class="next d-block col-md-6 text-lg-right" href="/one-on-one/">What to Talk about in Effective 1-on-1s &raquo; </a> <div class="clearfix"></div> </div> </div> </div> </div> </div> <div class="alertbar"> <div class="container text-center"> <span><img src="/assets/images/logo.png" alt="Charles Xu" height="32" width="32"> &nbsp; Never miss a <b>story</b> from me, subscribe to my newsletter</span> <form action="https://gmail.us5.list-manage.com/subscribe/post?u=b3d456844a3860642cd584c1b&amp;id=3f0c5c8bcd" method="post" name="mc-embedded-subscribe-form" class="wj-contact-form validate" target="_blank" novalidate> <div class="mc-field-group"> <input type="email" placeholder="Email" name="EMAIL" class="required email" id="mce-EMAIL" autocomplete="on" required> <input type="submit" value="Subscribe" name="subscribe" class="heart"> </div> </form> </div> </div> </div> <div class="jumbotron fortags"> <div class="d-md-flex h-100"> <div class="col-md-4 transpdark align-self-center text-center h-100"> <div class="d-md-flex align-items-center justify-content-center h-100"> <h2 class="d-md-block align-self-center py-1 font-weight-light">Explore <span class="d-none d-md-inline">→</span></h2> </div> </div> <div class="col-md-8 p-5 align-self-center text-center"> <a class="mt-1 mb-1" href="/categories#git">git (3)</a> <a class="mt-1 mb-1" href="/categories#web">web (6)</a> <a class="mt-1 mb-1" href="/categories#microservices">microservices (3)</a> <a class="mt-1 mb-1" href="/categories#distributed-systems">distributed systems (4)</a> <a class="mt-1 mb-1" href="/categories#signal-processing">signal processing (1)</a> <a class="mt-1 mb-1" href="/categories#istio">istio (3)</a> <a class="mt-1 mb-1" href="/categories#security">security (1)</a> <a class="mt-1 mb-1" href="/categories#docker">docker (2)</a> <a class="mt-1 mb-1" href="/categories#interview">interview (2)</a> <a class="mt-1 mb-1" href="/categories#kubernetes">kubernetes (6)</a> <a class="mt-1 mb-1" href="/categories#operation">operation (2)</a> <a class="mt-1 mb-1" href="/categories#networking">networking (4)</a> <a class="mt-1 mb-1" href="/categories#career">career (5)</a> <a class="mt-1 mb-1" href="/categories#go">go (1)</a> <a class="mt-1 mb-1" href="/categories#shell">shell (1)</a> <a class="mt-1 mb-1" href="/categories#investment">investment (1)</a> <a class="mt-1 mb-1" href="/categories#law">law (1)</a> <a class="mt-1 mb-1" href="/categories#startup">startup (4)</a> <a class="mt-1 mb-1" href="/categories#accounting">accounting (1)</a> <a class="mt-1 mb-1" href="/categories#oss">oss (1)</a> <a class="mt-1 mb-1" href="/categories#sales">sales (1)</a> <a class="mt-1 mb-1" href="/categories#advice">advice (1)</a> <a class="mt-1 mb-1" href="/categories#cloud">cloud (1)</a> </div> </div> </div> <footer class="footer"> <div class="container"> <div class="row"> <div class="col-md-6 col-sm-6 text-center text-lg-left" style="margin-bottom: 10px;"> Copyright © 2016-2023 Charles Xu </div> </div> </div> </footer> </div> <script src="/assets/js/popper.min.js"></script> <script src="/assets/js/bootstrap.min.js"></script> <script src="/assets/js/mediumish.js"></script> <script src="/assets/js/lazyload.js"></script> <script src="/assets/js/ie10-viewport-bug-workaround.js"></script> <link href="/assets/css/screen.css" rel="stylesheet"> <link href="/assets/css/main.css" rel="stylesheet"> </body> </html>