<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <link rel="icon" href="/assets/images/logo.png"> <title>Work Around Max Count of Security Group Rules on EKS | Charles Xu</title> <title>Work Around Max Count of Security Group Rules on EKS | Charles Xu</title> <meta name="generator" content="Jekyll v4.3.2"/> <meta property="og:title" content="Work Around Max Count of Security Group Rules on EKS"/> <meta property="og:locale" content="en_US"/> <meta name="description" content="AWS EKS on VPC networks need AWS Security Group Rules (SG) to receipt ingress traffic. But what if you reach the max rules count in your SG?"/> <meta property="og:description" content="AWS EKS on VPC networks need AWS Security Group Rules (SG) to receipt ingress traffic. But what if you reach the max rules count in your SG?"/> <meta property="og:site_name" content="Charles Xu"/> <meta property="og:image" content="/assets/images/eks-sg/cover3.jpeg"/> <meta property="og:type" content="article"/> <meta property="article:published_time" content="2023-09-26T00:00:00+00:00"/> <meta name="twitter:card" content="summary_large_image"/> <meta property="twitter:image" content="/assets/images/eks-sg/cover3.jpeg"/> <meta property="twitter:title" content="Work Around Max Count of Security Group Rules on EKS"/> <script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-09-26T00:00:00+00:00","datePublished":"2023-09-26T00:00:00+00:00","description":"AWS EKS on VPC networks need AWS Security Group Rules (SG) to receipt ingress traffic. But what if you reach the max rules count in your SG?","headline":"Work Around Max Count of Security Group Rules on EKS","image":"/assets/images/eks-sg/cover3.jpeg","mainEntityOfPage":{"@type":"WebPage","@id":"/eks-sg/"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"/assets/images/logo.png"}},"url":"/eks-sg/"}</script> <link href="/assets/css/bootstrap.min.css" rel="stylesheet"> <script src="/assets/js/jquery.min.js"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-8CYZ0N0EWJ"></script> <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-8CYZ0N0EWJ");</script> <script>!function(e,t,a,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=t.createElement(a),s=t.getElementsByTagName(a)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-151349369-1","auto"),ga("send","pageview");</script> <script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "5b6e3d4ee3274005a2d3321f9bb0516c"}'></script> <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"> </script> <script>window.MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]],processEscapes:!0}};</script> </head> <body class="layout-post"> <noscript id="deferred-styles"> <link href="/assets/css/fontawesome.css" rel="stylesheet"> <link href="/assets/css/google-fonts.css" rel="stylesheet"> </noscript> <nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top mediumnavigation nav-down"> <div class="container pr-0"> <a class="navbar-brand" href="/"> <img src="/assets/images/logo.png" alt="Charles Xu" height="32" width="32"> </a> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarMediumish" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <div class="collapse navbar-collapse" id="navbarMediumish"> <ul class="navbar-nav ml-auto"> <li class="nav-item"> <a class="nav-link" href="/about">About</a> </li> <li class="nav-item"> <a class="nav-link" href="/bookshelf">Bookshelf</a> </li> <li class="nav-item"> <a class="nav-link" href="/inspirations">Inspirations</a> </li> <li class="nav-item"> <a class="nav-link" href="/wiki">Wiki</a> </li> <li class="nav-item"> <a class="nav-link" href="/">Blog</a> </li> <script src="/assets/js/lunr.js"></script> <style>.lunrsearchresult .title{color:#d9230f}.lunrsearchresult .url{color:silver}.lunrsearchresult a{display:block;color:#777}.lunrsearchresult a:hover,.lunrsearchresult a:focus{text-decoration:none}.lunrsearchresult a:hover .title{text-decoration:underline}</style> <div style="width: 14px; height: 10px;"></div> <form class="bd-search" onSubmit="return lunr_search(document.getElementById('lunrsearch').value);"> <input type="text" class="form-control text-small launch-modal-search" id="lunrsearch" name="q" maxlength="255" value="" placeholder="Type and enter..."/> </form> <div id="lunrsearchresults"> <ul></ul> </div> <script src="/assets/js/lunrsearchengine.js"></script> </ul> </div> </div> </nav> <div class="site-content"> <div class="container"> <div class="mainheading"> <h1 class="sitetitle">Charles Xu</h1> <p class="lead"> Essays, books, wiki on technologies, career, markets, and more. </p> </div> <div id="loading"> <div id="loading-image" class="lds-ellipsis"><div></div><div></div><div></div><div></div></div> </div> <script>$(window).on("load",function(){$("#loading").hide()});</script> <div class="main-content"> <div class="container"> <div class="row"> <div class="col-md-2 pl-0"> <div class="share sticky-top sticky-top-offset"> <p> Share </p> <ul> <li class="ml-1 mr-1"> <a target="_blank" href="https://twitter.com/intent/tweet?text=Work Around Max Count of Security Group Rules on EKS&url=charlesxu.io/eks-sg/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;"> <i class="fab fa-twitter"></i> </a> </li> <li class="ml-1 mr-1"> <a target="_blank" href="https://facebook.com/sharer.php?u=charlesxu.io/eks-sg/" onclick="window.open(this.href, 'facebook-share', 'width=550,height=435');return false;"> <i class="fab fa-facebook-f"></i> </a> </li> <li class="ml-1 mr-1"> <a target="_blank" href="https://www.linkedin.com/shareArticle?mini=true&url=charlesxu.io/eks-sg/" onclick="window.open(this.href, 'width=550,height=435');return false;"> <i class="fab fa-linkedin-in"></i> </a> </li> </ul> <div class="sep"> </div> <ul> <li> <a class="small smoothscroll" href="#disqus_thread"></a> </li> </ul> </div> </div> <div class="col-md-8 flex-first flex-md-unordered"> <div class="mainheading"> <h1 class="posttitle">Work Around Max Count of Security Group Rules on EKS</h1> </div> <img class="featured-image img-fluid lazyimg" style="min-width: 100%" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAMAAAACCAQAAAA3fa6RAAAADklEQVR42mNkAANGCAUAACMAA2w/AMgAAAAASUVORK5CYII=" data-src="/assets/images/eks-sg/cover3.jpeg" alt="Work Around Max Count of Security Group Rules on EKS"> <div class="article-post"> <div class="toc mt-4 mb-4 lead"> <h3 style="color: #9c9c9c">Table of Contents</h3> <ul> <li><a href="#background">Background</a> <ul> <li><a href="#loadbalancer-type-service-and-security-group-rules">LoadBalancer-type Service and Security Group Rules</a></li> <li><a href="#security-group-limits">Security Group Limits</a></li> </ul> </li> <li><a href="#problem">Problem</a></li> <li><a href="#solutions">Solutions</a> <ul> <li><a href="#second-dedicated-sg-for-each-node-pools">Second dedicated SG for each node pools</a></li> <li><a href="#optimize-sg-rules-outside-of-aws-lb-controller">Optimize SG rules outside of aws LB controller</a></li> <li><a href="#raise-max-inbound-rules-per-sg-by-reducing-sg-count-per-eni">Raise max inbound rules per SG by reducing SG count per ENI</a></li> <li><a href="#build-eks-clusters-in-a-separate-aws-account">Build EKS clusters in a separate AWS account</a></li> </ul> </li> </ul> </div> <p>AWS EKS on VPC networks need AWS Security Group Rules (SG) to receipt ingress traffic. But what if you reach the max rules count in your SG?</p> <h3 id="background">Background</h3> <h4 id="loadbalancer-type-service-and-security-group-rules">LoadBalancer-type Service and Security Group Rules</h4> <p>Kubernetes users can expose a Service in two ways:</p> <ul> <li>Register with the Istio ingress gateways—the golden path for most tenants</li> <li>Create a dedicated LoadBalancer-type Service object, which tells the cloud provider to create a load balancer and set up health checks.</li> </ul> <p>EKS recommends <a href="https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.5/">aws-load-balancer-controller</a> to react to updates to <code class="language-plaintext highlighter-rouge">LoadBalancer</code>-type Service objects and set up NLB accordingly. For example, suppose a Service object exposes ports 80 and 443, the controller will create five Security Group (SG) Rules on EKS worker Nodes:</p> <ol> <li>allow ingress source <code class="language-plaintext highlighter-rouge">0.0.0.0/0</code> to the corresponding <a href="https://kubernetes.io/docs/concepts/services-networking/service/#type-nodeport">NodePort</a> for port <code class="language-plaintext highlighter-rouge">80</code></li> <li>allow ingress source <code class="language-plaintext highlighter-rouge">0.0.0.0/0</code> to the corresponding NodePort for port <code class="language-plaintext highlighter-rouge">443</code></li> <li>allow EKS zonal subnet in <code class="language-plaintext highlighter-rouge">us-west-2a</code> to ingress to the health-check NodePort.</li> <li>allow EKS zonal subnet in <code class="language-plaintext highlighter-rouge">us-west-2b</code> to ingress to the health-check NodePort</li> <li>allow EKS zonal subnet in <code class="language-plaintext highlighter-rouge">us-west-2c</code> to ingress to the health-check NodePort</li> </ol> <p>Note: health-check will fail if a) the Node does not host any target Pods or b) none of the target Pods on this Node is ready, determined by the Pod’s readiness probe</p> <p>The SG Rules are added to an SG attached to all worker Nodes in the given EKS.</p> <h4 id="security-group-limits">Security Group Limits</h4> <p>For each AWS account, there are two quota limits on Security Groups:</p> <ol> <li>Max number of inbound rules per SG</li> <li>Max number of SGs per network interface</li> </ol> <p>These limits can be adjusted subject to the constraint that the product of the two quotas cannot exceed 1000 (AWS <a href="https://docs.aws.amazon.com/vpc/latest/userguide/amazon-vpc-limits.html#vpc-limits-security-groups">doc</a>). It means a network interface can not have more than 1000 SG rules.</p> <h3 id="problem">Problem</h3> <p>Once your EKS cluster approaches the limit of SG rules, it restricts your ability to create new load balancers. It means you won’t be able to perform blue-green upgrade of the load balancer, because you need to provision two sets of load balancers simultaneously. The lack of headroom also means you can no longer onboard more applications that requires a dedicated load balancer.</p> <h3 id="solutions">Solutions</h3> <p>The following solutions are not mutually exclusive. They can be used together.</p> <h4 id="second-dedicated-sg-for-each-node-pools">Second dedicated SG for each node pools</h4> <p>Suppose your current setup is that all worker Nodes, regardless node pool, has a shared SG attached named “worker”. The <code class="language-plaintext highlighter-rouge">aws-load-balancer-controller</code> adds new rules to the “worker” SG.</p> <p>You can keep the shared “worker” SG to store common rules but create a new SG for each node pool, and use the new SG for NLBs ingress. You need to change the node pool launch template to attach the new SG.</p> <p>If you decide to continue letting the AWS LB controller manage SG rules for us, you should tag the new SG with <code class="language-plaintext highlighter-rouge">kubernetes.io/cluster/{{ .ClusterName }}: shared</code>. This is necessary when there are multiple security groups attached to an ENI, so that the controller knows which SG to add new rules to. Because the existing “worker” SG has this tag already, we need to create a duplicate SG, say “worker2”, which does NOT have the SG tag for NLB. Then, we will attach to the node pool the “worker2” SG and the per-pool SG.</p> <h4 id="optimize-sg-rules-outside-of-aws-lb-controller">Optimize SG rules outside of aws LB controller</h4> <p>Recall the <code class="language-plaintext highlighter-rouge">aws-load-balancer-controller</code> implementation creates 5 inbound SG rules per envoy-ingress Service. We can optimize this by managing the SG rules ourselves and asking the controller to skip SG rules creation. We can reduce the need to 2 inbound SG rules per envoy-ingress Service.</p> <p>Add the <code class="language-plaintext highlighter-rouge">service.beta.kubernetes.io/aws-load-balancer-manage-backend-security-group-rules: false</code>` annotation to the LoadBalancer-type Service object. Documentation about this annotation is <a href="https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.4/guide/service/annotations/#manage-backend-sg-rules">here</a>.</p> <p><strong>Reserve 3 static NodePorts for each Service.</strong> One for NLB to health check the EKS nodes. One for frontend port 80. One for frontend port 443. You <a href="https://kubernetes.io/docs/tasks/access-application-cluster/create-external-load-balancer/#preserving-the-client-source-ip">can choose</a> a static <code class="language-plaintext highlighter-rouge">healthCheckNodePort</code> if you set <code class="language-plaintext highlighter-rouge">externalTrafficPolicy: Local</code> (which comes with the benefits to preserve source IP address). The two regular NodePorts can be static regardless.</p> <p><strong>The two regular NodePorts should be consecutive</strong>, so one SG rule can cover both. The <code class="language-plaintext highlighter-rouge">healthCheckNodePort</code> does not need to be consecutive, because the source IP range in the SG rule is different (i.e. only allow NLB to healthcheck the nodes).</p> <p>Consider the following example:</p> <div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="rouge-code"><pre> apiVersion: v1
 kind: Service
 metadata:
   annotations:
     external-dns.alpha.kubernetes.io/hostname: acmecorp.com
     service.beta.kubernetes.io/aws-load-balancer-nlb-target-type: instance
     service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing
     service.beta.kubernetes.io/aws-load-balancer-type: external
<span class="gi">+    service.beta.kubernetes.io/aws-load-balancer-manage-backend-security-group-rules: false
</span>   name: myapp
   namespace: myapp
 spec:
   externalTrafficPolicy: Local
<span class="gi">+  healthCheckNodePort: 30218
</span>   ports:
     - name: https
<span class="gi">+      nodePort: 30212
</span>       port: 443
       protocol: TCP
       targetPort: 8095
     - name: http
<span class="gi">+      nodePort: 30213
</span>       port: 80
       protocol: TCP
       targetPort: 8089
   selector:
     app: myapp
   type: LoadBalancer
</pre></td></tr></tbody></table></code></pre></div></div> <p>The optimized SG rules would be:</p> <ul> <li><del style="color: #9c9c9c">allow ingress source <code class="language-plaintext highlighter-rouge">0.0.0.0/0</code> to the corresponding NodePort for port <code class="language-plaintext highlighter-rouge">80</code></del></li> <li><del style="color: #9c9c9c">allow ingress source <code class="language-plaintext highlighter-rouge">0.0.0.0/0</code> to the corresponding NodePort for port <code class="language-plaintext highlighter-rouge">443</code></del></li> <li> <p>allow source <code class="language-plaintext highlighter-rouge">0.0.0.0/</code>0 to ingress to NodePort range from <code class="language-plaintext highlighter-rouge">30212</code> to <code class="language-plaintext highlighter-rouge">30213</code></p> </li> <li><del style="color: #9c9c9c">allow EKS zonal subnet in <code class="language-plaintext highlighter-rouge">us-west-2a</code> to ingress to the health-check NodePort</del></li> <li><del style="color: #9c9c9c">allow EKS zonal subnet in <code class="language-plaintext highlighter-rouge">us-west-2b</code> to ingress to the health-check NodePort</del></li> <li><del style="color: #9c9c9c">allow EKS zonal subnet in <code class="language-plaintext highlighter-rouge">us-west-2c</code> to ingress to the health-check NodePort</del></li> <li>allow EKS VPC network in region <code class="language-plaintext highlighter-rouge">us-west-2</code> to ingress to the health-check NodePort</li> </ul> <h4 id="raise-max-inbound-rules-per-sg-by-reducing-sg-count-per-eni">Raise max inbound rules per SG by reducing SG count per ENI</h4> <p>The solution picks a different point on the trade-off spectrum between #Inbound rules per SG and #SG per ENI.</p> <p>SG quota is set for each and whole AWS account, so any adjustment will affect other workloads in the same account. Thus, we need to verify whether the existing AWS account has ENI with max number of SGs attached already.</p> <h4 id="build-eks-clusters-in-a-separate-aws-account">Build EKS clusters in a separate AWS account</h4> <p>Building new clusters and shifting tenants over are expensive. Try other solutions first.</p> </div> <p> <small> <span class="post-date"><time class="post-date" datetime="2023-09-26">26 Sep 2023</time></span> </small> </p> <div class="after-post-cats"> <ul class="tags mb-4"> <li> <a class="smoothscroll" href="/categories#cloud">cloud</a> </li> <li> <a class="smoothscroll" href="/categories#kubernetes">kubernetes</a> </li> <li> <a class="smoothscroll" href="/categories#networking">networking</a> </li> </ul> </div> <div class="after-post-tags"> <ul class="tags"> </ul> </div> <div class="row PageNavigation d-flex justify-content-between font-weight-bold"> <a class="prev d-block col-md-6" href="/source-ip-autoscale/"> &laquo; Layer-4 Load Balancer & Zero-downtime Autoscaling and Upgrade</a> <a class="next d-block col-md-6 text-lg-right" href="/scaling-istio/">Scaling Istio &raquo; </a> <div class="clearfix"></div> </div> </div> </div> </div> </div> <div class="alertbar"> <div class="container text-center"> <span><img src="/assets/images/logo.png" alt="Charles Xu" height="32" width="32"> &nbsp; Never miss a <b>story</b> from me, subscribe to my newsletter</span> <form action="https://gmail.us5.list-manage.com/subscribe/post?u=b3d456844a3860642cd584c1b&amp;id=3f0c5c8bcd" method="post" name="mc-embedded-subscribe-form" class="wj-contact-form validate" target="_blank" novalidate> <div class="mc-field-group"> <input type="email" placeholder="Email" name="EMAIL" class="required email" id="mce-EMAIL" autocomplete="on" required> <input type="submit" value="Subscribe" name="subscribe" class="heart"> </div> </form> </div> </div> </div> <div class="jumbotron fortags"> <div class="d-md-flex h-100"> <div class="col-md-4 transpdark align-self-center text-center h-100"> <div class="d-md-flex align-items-center justify-content-center h-100"> <h2 class="d-md-block align-self-center py-1 font-weight-light">Explore <span class="d-none d-md-inline">→</span></h2> </div> </div> <div class="col-md-8 p-5 align-self-center text-center"> <a class="mt-1 mb-1" href="/categories#git">git (3)</a> <a class="mt-1 mb-1" href="/categories#web">web (9)</a> <a class="mt-1 mb-1" href="/categories#microservices">microservices (8)</a> <a class="mt-1 mb-1" href="/categories#distributed-systems">distributed systems (6)</a> <a class="mt-1 mb-1" href="/categories#signal-processing">signal processing (1)</a> <a class="mt-1 mb-1" href="/categories#networking">networking (11)</a> <a class="mt-1 mb-1" href="/categories#istio">istio (4)</a> <a class="mt-1 mb-1" href="/categories#security">security (1)</a> <a class="mt-1 mb-1" href="/categories#docker">docker (2)</a> <a class="mt-1 mb-1" href="/categories#kubernetes">kubernetes (9)</a> <a class="mt-1 mb-1" href="/categories#operation">operation (4)</a> <a class="mt-1 mb-1" href="/categories#career">career (5)</a> <a class="mt-1 mb-1" href="/categories#go">go (1)</a> <a class="mt-1 mb-1" href="/categories#cloud">cloud (4)</a> <a class="mt-1 mb-1" href="/categories#investment">investment (2)</a> <a class="mt-1 mb-1" href="/categories#startup">startup (6)</a> <a class="mt-1 mb-1" href="/categories#oss">oss (1)</a> <a class="mt-1 mb-1" href="/categories#artificial-intelligence">artificial intelligence (1)</a> <a class="mt-1 mb-1" href="/categories#llm">llm (1)</a> </div> </div> </div> <footer class="footer"> <div class="container"> <div class="row"> <div class="col-md-6 col-sm-6 text-center text-lg-left" style="margin-bottom: 10px;"> Copyright © 2016-2025 Charles Xu </div> </div> </div> </footer> </div> <script src="/assets/js/popper.min.js"></script> <script src="/assets/js/bootstrap.min.js"></script> <script src="/assets/js/mediumish.js"></script> <script src="/assets/js/lazyload.js"></script> <script src="/assets/js/ie10-viewport-bug-workaround.js"></script> <link href="/assets/css/screen.css" rel="stylesheet"> <link href="/assets/css/main.css" rel="stylesheet"> </body> </html>