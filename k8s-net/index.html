<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <link rel="icon" href="/assets/images/logo.png"> <title>Kubernetes Networking From the First Principles | Charles Xu</title> <title>Kubernetes Networking From the First Principles | Charles Xu</title> <meta name="generator" content="Jekyll v4.3.2"/> <meta property="og:title" content="Kubernetes Networking From the First Principles"/> <meta property="og:locale" content="en_US"/> <meta name="description" content="We go from containers and network namespace to Pod-to-Pod, Pod-to-Service, and external-client-to-Service networking."/> <meta property="og:description" content="We go from containers and network namespace to Pod-to-Pod, Pod-to-Service, and external-client-to-Service networking."/> <meta property="og:site_name" content="Charles Xu"/> <meta property="og:image" content="/assets/images/k8s-net/cover.jpeg"/> <meta property="og:type" content="article"/> <meta property="article:published_time" content="2022-03-01T00:00:00+00:00"/> <meta name="twitter:card" content="summary_large_image"/> <meta property="twitter:image" content="/assets/images/k8s-net/cover.jpeg"/> <meta property="twitter:title" content="Kubernetes Networking From the First Principles"/> <script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-03-01T00:00:00+00:00","datePublished":"2022-03-01T00:00:00+00:00","description":"We go from containers and network namespace to Pod-to-Pod, Pod-to-Service, and external-client-to-Service networking.","headline":"Kubernetes Networking From the First Principles","image":"/assets/images/k8s-net/cover.jpeg","mainEntityOfPage":{"@type":"WebPage","@id":"/k8s-net/"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"/assets/images/logo.png"}},"url":"/k8s-net/"}</script> <link href="/assets/css/bootstrap.min.css" rel="stylesheet"> <script src="/assets/js/jquery.min.js"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-8CYZ0N0EWJ"></script> <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-8CYZ0N0EWJ");</script> <script>!function(e,t,a,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=t.createElement(a),s=t.getElementsByTagName(a)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-151349369-1","auto"),ga("send","pageview");</script> <script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "5b6e3d4ee3274005a2d3321f9bb0516c"}'></script> </head> <body class="layout-post"> <noscript id="deferred-styles"> <link href="/assets/css/fontawesome.css" rel="stylesheet"> <link href="/assets/css/google-fonts.css" rel="stylesheet"> </noscript> <nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top mediumnavigation nav-down"> <div class="container pr-0"> <a class="navbar-brand" href="/"> <img src="/assets/images/logo.png" alt="Charles Xu" height="32" width="32"> </a> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarMediumish" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <div class="collapse navbar-collapse" id="navbarMediumish"> <ul class="navbar-nav ml-auto"> <li class="nav-item"> <a class="nav-link" href="/about">About</a> </li> <li class="nav-item"> <a class="nav-link" href="/bookshelf">Bookshelf</a> </li> <li class="nav-item"> <a class="nav-link" href="/inspirations">Inspirations</a> </li> <li class="nav-item"> <a class="nav-link" href="/wiki">Wiki</a> </li> <li class="nav-item"> <a class="nav-link" href="/">Blog</a> </li> <script src="/assets/js/lunr.js"></script> <style>.lunrsearchresult .title{color:#d9230f}.lunrsearchresult .url{color:silver}.lunrsearchresult a{display:block;color:#777}.lunrsearchresult a:hover,.lunrsearchresult a:focus{text-decoration:none}.lunrsearchresult a:hover .title{text-decoration:underline}</style> <div style="width: 14px; height: 10px;"></div> <form class="bd-search" onSubmit="return lunr_search(document.getElementById('lunrsearch').value);"> <input type="text" class="form-control text-small launch-modal-search" id="lunrsearch" name="q" maxlength="255" value="" placeholder="Type and enter..."/> </form> <div id="lunrsearchresults"> <ul></ul> </div> <script src="/assets/js/lunrsearchengine.js"></script> </ul> </div> </div> </nav> <div class="site-content"> <div class="container"> <div class="mainheading"> <h1 class="sitetitle">Charles Xu</h1> <p class="lead"> Essays, books, wiki on technologies, career, markets, and more. </p> </div> <div id="loading"> <div id="loading-image" class="lds-ellipsis"><div></div><div></div><div></div><div></div></div> </div> <script>$(window).on("load",function(){$("#loading").hide()});</script> <div class="main-content"> <div class="container"> <div class="row"> <div class="col-md-2 pl-0"> <div class="share sticky-top sticky-top-offset"> <p> Share </p> <ul> <li class="ml-1 mr-1"> <a target="_blank" href="https://twitter.com/intent/tweet?text=Kubernetes Networking From the First Principles&url=charlesxu.io/k8s-net/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;"> <i class="fab fa-twitter"></i> </a> </li> <li class="ml-1 mr-1"> <a target="_blank" href="https://facebook.com/sharer.php?u=charlesxu.io/k8s-net/" onclick="window.open(this.href, 'facebook-share', 'width=550,height=435');return false;"> <i class="fab fa-facebook-f"></i> </a> </li> <li class="ml-1 mr-1"> <a target="_blank" href="https://www.linkedin.com/shareArticle?mini=true&url=charlesxu.io/k8s-net/" onclick="window.open(this.href, 'width=550,height=435');return false;"> <i class="fab fa-linkedin-in"></i> </a> </li> </ul> <div class="sep"> </div> <ul> <li> <a class="small smoothscroll" href="#disqus_thread"></a> </li> </ul> </div> </div> <div class="col-md-8 flex-first flex-md-unordered"> <div class="mainheading"> <h1 class="posttitle">Kubernetes Networking From the First Principles</h1> </div> <img class="featured-image img-fluid lazyimg" style="min-width: 100%" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAMAAAACCAQAAAA3fa6RAAAADklEQVR42mNkAANGCAUAACMAA2w/AMgAAAAASUVORK5CYII=" data-src="/assets/images/k8s-net/cover.jpeg" alt="Kubernetes Networking From the First Principles"> <div class="article-post"> <div class="toc mt-4 mb-4 lead"> <h3 style="color: #9c9c9c">Table of Contents</h3> <ul> <li><a href="#pods">Pods</a> <ul> <li><a href="#pod-to-pod-on-the-same-node">Pod to Pod on the same Node</a></li> <li><a href="#pod-to-pod-on-another-node">Pod to Pod on another Node</a></li> </ul> </li> <li><a href="#clusterip-type-services">ClusterIP-type Services</a></li> <li><a href="#nodeport-type-services">NodePort-type Services</a></li> </ul> </div> <p>We go from containers and network namespace to Pod-to-Pod, Pod-to-Service, and external-client-to-Service networking.</p> <h3 id="pods">Pods</h3> <p>Containers of the same Pod share the same Linux network namespace, isolated from the host network namespace.</p> <p>Each Pod gets a separate network namespace and is assigned a cluster-wide unique IP address from the cluster’s Pod CIDR range. Many managed Kubernetes offerings use Host-local IPAM (IP Address Management), so that each Node is fist assigned a subnet of Pod CIDR. Then, each Pod gets its IP address from the Node the Pod is on.</p> <p>The Kubernetes networking model requires that a container in Pod A can reach a container in Pod B, crossing network namespaces, regardless of whether Pods A and B are on the same Node or not.</p> <h4 id="pod-to-pod-on-the-same-node">Pod to Pod on the same Node</h4> <p>For each Pod, kubelet will create a VETH (Virtual Ethernet Device) pair in the host network namespace. Packets transmitted on one device in the pair are immediately received on the other device. Then Kubelet will move one device of such pair into the Pod’s network namespace and rename this device to <code class="language-plaintext highlighter-rouge">eth0</code> in the Pod’s namespace. Each VETH device remained in the host network namespace will be assigned a Pod IP and be connected to a software bridge <code class="language-plaintext highlighter-rouge">cbr0</code>.</p> <div style="text-align: center"> <p><img src="/assets/images/k8s-net/p1.png" width="400"/></p> </div> <h4 id="pod-to-pod-on-another-node">Pod to Pod on another Node</h4> <div style="text-align: center"> <p><img src="/assets/images/k8s-net/p2.png" width="1000"/></p> </div> <p>On <code class="language-plaintext highlighter-rouge">Node-1</code>, IP packets (whose source and destination addresses are the Pod IPs) sent by <code class="language-plaintext highlighter-rouge">pod-1</code> will be encapsulated as Ethernet frames being sent to <code class="language-plaintext highlighter-rouge">cbr0</code>.</p> <p>The <code class="language-plaintext highlighter-rouge">cbr0</code> switch has a match-all forwarding rule for all packets destinated to anything but <code class="language-plaintext highlighter-rouge">Node-1</code>’s subnet of Pod CIDR. The CNI plugin in VXLAN mode will encapsulate the Ethernet frames as UDP packets. These UDP packets’ source and destination addresses are the Node IPs.</p> <h3 id="clusterip-type-services">ClusterIP-type Services</h3> <p>Even though Pod IPs are routable, Pods (and hence the Pod IPs) are ephemeral by design. Hence, it is more reliable and recommended to use the Kubernetes <code class="language-plaintext highlighter-rouge">Service</code>, which provides a static cluster IP and load balancing over a group of Pods. The most basic Service type is <code class="language-plaintext highlighter-rouge">ClusterIP</code>, which represents a service available within the cluster but not exposed to the internet.</p> <p>ClusterIP-type Services are implemented using kube-proxy, which is not a real proxy (data plane) but configures iptables to capture and NAT traffic to cluster IP of the Service.</p> <p>Below is an example of <code class="language-plaintext highlighter-rouge">pod-1</code> sending a request to <code class="language-plaintext highlighter-rouge">service-1</code> backed by <code class="language-plaintext highlighter-rouge">pod-0</code> and <code class="language-plaintext highlighter-rouge">pod-2</code>. Encapsulation details covered in the previous section are omitted from the diagram below.</p> <div style="text-align: center"> <p><img src="/assets/images/k8s-net/p3.png" width="1000"/></p> </div> <p>Kube-proxy will choose at random one of the backing Pods to serve the request, by dNATing the destination IP from the Service’s cluster IP to the IP of the chosen Pod, which in this example is <code class="language-plaintext highlighter-rouge">pod-2</code>. Note that the response from <code class="language-plaintext highlighter-rouge">pod-2</code> will be sNATed back to the Service’s cluster IP, so that kube-proxy remains transparent to workloads. Otherwise, <code class="language-plaintext highlighter-rouge">pod-1</code> only has connection states about <code class="language-plaintext highlighter-rouge">service-1</code>, not <code class="language-plaintext highlighter-rouge">pod-2</code>, and thus will reset the connection.</p> <h3 id="nodeport-type-services">NodePort-type Services</h3> <p>To expose a service to clients outside of the cluster, use the NodePort-type Service, which reserves the same port on each Node such that the client could access the service by hitting the NodePort on any Nodes.</p> <p>The example below assumes <code class="language-plaintext highlighter-rouge">externalTrafficPolicy</code> is set to <code class="language-plaintext highlighter-rouge">Cluster</code>, which means traffic can be routed to a backing Pod on a different Node. Here, the cluster-external client send requests to the NodePort of <code class="language-plaintext highlighter-rouge">service-1</code> on <code class="language-plaintext highlighter-rouge">Node-0</code>, and kube-proxy chooses <code class="language-plaintext highlighter-rouge">pod-2</code> to serve the request.</p> <div style="text-align: center"> <p><img src="/assets/images/k8s-net/p4.png" width="1000"/></p> </div> <p>Obviously the destination address will be masqueraded from <code class="language-plaintext highlighter-rouge">Node-0</code> to <code class="language-plaintext highlighter-rouge">pod-2</code>, but notice that source address is also masqueraded, from the client IP to <code class="language-plaintext highlighter-rouge">Node-0</code>’s IP. Source-NATing is necessary, because otherwise <code class="language-plaintext highlighter-rouge">pod-2</code> will respond directly to the client, who assume it is maintaining a connection to <code class="language-plaintext highlighter-rouge">Node-0</code>.</p> </div> <p> <small> <span class="post-date"><time class="post-date" datetime="2022-03-01">01 Mar 2022</time></span> </small> </p> <div class="after-post-cats"> <ul class="tags mb-4"> <li> <a class="smoothscroll" href="/categories#kubernetes">kubernetes</a> </li> <li> <a class="smoothscroll" href="/categories#networking">networking</a> </li> </ul> </div> <div class="after-post-tags"> <ul class="tags"> </ul> </div> <div class="row PageNavigation d-flex justify-content-between font-weight-bold"> <a class="prev d-block col-md-6" href="/accounting/"> &laquo; Accounting Advice for Founders</a> <a class="next d-block col-md-6 text-lg-right" href="/streamlit-interview/">Interviewing Adrien Treuille, Founder CEO of Streamlit &raquo; </a> <div class="clearfix"></div> </div> </div> </div> </div> </div> <div class="alertbar"> <div class="container text-center"> <span><img src="/assets/images/logo.png" alt="Charles Xu" height="32" width="32"> &nbsp; Never miss a <b>story</b> from me, subscribe to my newsletter</span> <form action="https://gmail.us5.list-manage.com/subscribe/post?u=b3d456844a3860642cd584c1b&amp;id=3f0c5c8bcd" method="post" name="mc-embedded-subscribe-form" class="wj-contact-form validate" target="_blank" novalidate> <div class="mc-field-group"> <input type="email" placeholder="Email" name="EMAIL" class="required email" id="mce-EMAIL" autocomplete="on" required> <input type="submit" value="Subscribe" name="subscribe" class="heart"> </div> </form> </div> </div> </div> <div class="jumbotron fortags"> <div class="d-md-flex h-100"> <div class="col-md-4 transpdark align-self-center text-center h-100"> <div class="d-md-flex align-items-center justify-content-center h-100"> <h2 class="d-md-block align-self-center py-1 font-weight-light">Explore <span class="d-none d-md-inline">→</span></h2> </div> </div> <div class="col-md-8 p-5 align-self-center text-center"> <a class="mt-1 mb-1" href="/categories#git">git (3)</a> <a class="mt-1 mb-1" href="/categories#web">web (9)</a> <a class="mt-1 mb-1" href="/categories#microservices">microservices (7)</a> <a class="mt-1 mb-1" href="/categories#distributed-systems">distributed systems (6)</a> <a class="mt-1 mb-1" href="/categories#signal-processing">signal processing (1)</a> <a class="mt-1 mb-1" href="/categories#networking">networking (11)</a> <a class="mt-1 mb-1" href="/categories#istio">istio (4)</a> <a class="mt-1 mb-1" href="/categories#security">security (1)</a> <a class="mt-1 mb-1" href="/categories#docker">docker (2)</a> <a class="mt-1 mb-1" href="/categories#kubernetes">kubernetes (9)</a> <a class="mt-1 mb-1" href="/categories#operation">operation (4)</a> <a class="mt-1 mb-1" href="/categories#career">career (5)</a> <a class="mt-1 mb-1" href="/categories#go">go (1)</a> <a class="mt-1 mb-1" href="/categories#cloud">cloud (4)</a> <a class="mt-1 mb-1" href="/categories#investment">investment (1)</a> <a class="mt-1 mb-1" href="/categories#startup">startup (4)</a> <a class="mt-1 mb-1" href="/categories#oss">oss (1)</a> </div> </div> </div> <footer class="footer"> <div class="container"> <div class="row"> <div class="col-md-6 col-sm-6 text-center text-lg-left" style="margin-bottom: 10px;"> Copyright © 2016-2023 Charles Xu </div> </div> </div> </footer> </div> <script src="/assets/js/popper.min.js"></script> <script src="/assets/js/bootstrap.min.js"></script> <script src="/assets/js/mediumish.js"></script> <script src="/assets/js/lazyload.js"></script> <script src="/assets/js/ie10-viewport-bug-workaround.js"></script> <link href="/assets/css/screen.css" rel="stylesheet"> <link href="/assets/css/main.css" rel="stylesheet"> </body> </html>