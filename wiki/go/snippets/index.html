<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <link rel="icon" href="/assets/images/logo.png"> <title>Useful Go Snippets | Charles Xu</title> <title>Useful Go Snippets | Charles Xu</title> <meta name="generator" content="Jekyll v4.2.0"/> <meta property="og:title" content="Useful Go Snippets"/> <meta property="og:locale" content="en_US"/> <meta name="description" content="Essays, books, wiki on technologies, career, markets, and more."/> <meta property="og:description" content="Essays, books, wiki on technologies, career, markets, and more."/> <meta property="og:site_name" content="Charles Xu"/> <meta name="twitter:card" content="summary"/> <meta property="twitter:title" content="Useful Go Snippets"/> <script type="application/ld+json">
{"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"/assets/images/logo.png"}},"headline":"Useful Go Snippets","@type":"WebPage","description":"Essays, books, wiki on technologies, career, markets, and more.","url":"/wiki/go/snippets/","@context":"https://schema.org"}</script> <link href="/assets/css/bootstrap.min.css" rel="stylesheet"> <script src="/assets/js/jquery.min.js"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-8CYZ0N0EWJ"></script> <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-8CYZ0N0EWJ");</script> <script>!function(e,t,a,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=t.createElement(a),s=t.getElementsByTagName(a)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-151349369-1","auto"),ga("send","pageview");</script> <script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "5b6e3d4ee3274005a2d3321f9bb0516c"}'></script> </head> <body class="layout-wiki"> <noscript id="deferred-styles"> <link href="/assets/css/fontawesome.css" rel="stylesheet"> <link href="/assets/css/google-fonts.css" rel="stylesheet"> </noscript> <nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top mediumnavigation nav-down"> <div class="container pr-0"> <a class="navbar-brand" href="/"> <img src="/assets/images/logo.png" alt="Charles Xu" height="32" width="32"> </a> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarMediumish" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <div class="collapse navbar-collapse" id="navbarMediumish"> <ul class="navbar-nav ml-auto"> <li class="nav-item"> <a class="nav-link" href="/about">About</a> </li> <li class="nav-item"> <a class="nav-link" href="/bookshelf">Bookshelf</a> </li> <li class="nav-item"> <a class="nav-link" href="/inspirations">Inspirations</a> </li> <li class="nav-item active"> <a class="nav-link" href="/wiki">Wiki</a> </li> <li class="nav-item"> <a class="nav-link" href="/">Blog</a> </li> <script src="/assets/js/lunr.js"></script> <style>.lunrsearchresult .title{color:#d9230f}.lunrsearchresult .url{color:silver}.lunrsearchresult a{display:block;color:#777}.lunrsearchresult a:hover,.lunrsearchresult a:focus{text-decoration:none}.lunrsearchresult a:hover .title{text-decoration:underline}</style> <div style="width: 14px; height: 10px;"></div> <form class="bd-search" onSubmit="return lunr_search(document.getElementById('lunrsearch').value);"> <input type="text" class="form-control text-small launch-modal-search" id="lunrsearch" name="q" maxlength="255" value="" placeholder="Type and enter..."/> </form> <div id="lunrsearchresults"> <ul></ul> </div> <script src="/assets/js/lunrsearchengine.js"></script> </ul> </div> </div> </nav> <div class="site-content"> <div class="container"> <div class="mainheading"> <h1 class="sitetitle">Charles Xu</h1> <p class="lead"> Essays, books, wiki on technologies, career, markets, and more. </p> </div> <div id="loading"> <div id="loading-image" class="lds-ellipsis"><div></div><div></div><div></div><div></div></div> </div> <script>$(window).on("load",function(){$("#loading").hide()});</script> <div class="main-content"> <div class="section-title"> <h2><span>Wiki</span></h2> </div> <div class="row" style="font-size: 0.92rem"> <div class="col-md-2" style="min-width: 200px; font-size: 0.92rem;"> <div class="wiki-left-panel sticky-top wiki-sticky-top-offset"> <div class="scroll"> <div class="scroll-prompt">* Scroll me *</div> <div class="section-title ">PREFACE</div> <a href="/wiki/" class="wiki-tab "> <div>About Wiki</div> </a> <div class="section-title ">GOLANG</div> <a href="/wiki/go/snippets/" class="wiki-tab active"> <div>Snippets</div> </a> <a href="/wiki/go/pitfalls/" class="wiki-tab "> <div>Pitfalls</div> </a> <a href="/wiki/go/development/" class="wiki-tab "> <div>Development</div> </a> <a href="/wiki/go/production/" class="wiki-tab "> <div>Production</div> </a> <div class="section-title ">SHELL</div> <a href="/wiki/shell/" class="wiki-tab "> <div>Shell Script</div> </a> <div class="section-title ">NETWORKING</div> <a href="/wiki/networking/" class="wiki-tab "> <div>Networking</div> </a> <div class="section-title ">KUBERNETES</div> <a href="/wiki/kubernetes/commands" class="wiki-tab "> <div>Commands</div> </a> <a href="/wiki/kubernetes/patterns" class="wiki-tab "> <div>Patterns</div> </a> <a href="/wiki/kubernetes/potholes" class="wiki-tab "> <div>Potholes</div> </a> <div class="section-title ">ISTIO</div> <a href="/wiki/istio/" class="wiki-tab "> <div>Istio</div> </a> <div class="section-title ">INFRA AS CODE</div> <a href="/wiki/infra-as-code/terraform/" class="wiki-tab "> <div>Terraform</div> </a> <a href="/wiki/infra-as-code/pulumi/" class="wiki-tab "> <div>Pulumi</div> </a> </div> </div> </div> <div style="min-width: 50px; min-height: 30px;"></div> <div class="col-md-7"> <div class="mainheading"> <h1 class="posttitle">Useful Go Snippets</h1> </div> <div class="article-post"> <div class="toc"> <h3 style="color: #9c9c9c">Table of Contents</h3> <ul> <li><a href="#interface">Interface</a></li> <li><a href="#network">Network</a> <ul> <li><a href="#serve-http-multiplexer-under-subpath">Serve http multiplexer under subpath</a></li> <li><a href="#test-server-with-any-available-port">Test server with any available port</a></li> </ul> </li> <li><a href="#struct">Struct</a> <ul> <li><a href="#validate-fields-and-set-default-values">Validate Fields and Set Default Values</a></li> <li><a href="#hashset-with-empty-struct">HashSet with Empty Struct</a></li> </ul> </li> <li><a href="#functional-options">Functional Options</a></li> <li><a href="#certificate-signing-requests-with-email-address">Certificate Signing Requests with Email Address</a></li> <li><a href="#operators">Operators</a></li> </ul> </div> <h3 id="interface">Interface</h3> <p>To assert that a struct implements an interface:</p> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">var</span> <span class="n">_</span> <span class="n">CoolInterface</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">CuteStruct</span><span class="p">)(</span><span class="no">nil</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div> <h3 id="network">Network</h3> <h4 id="serve-http-multiplexer-under-subpath">Serve http multiplexer under subpath</h4> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="k">import</span> 	<span class="s">"github.com/grpc-ecosystem/grpc-gateway/v2/runtime"</span>

<span class="n">gwmux</span> <span class="o">:=</span> <span class="n">runtime</span><span class="o">.</span><span class="n">NewServeMux</span><span class="p">()</span>
<span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">pb</span><span class="o">.</span><span class="n">RegisterSomeServiceHandler</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">gwmux</span><span class="p">,</span> <span class="n">conn</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="nb">panic</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">mux</span> <span class="o">:=</span> <span class="n">http</span><span class="o">.</span><span class="n">NewServeMux</span><span class="p">()</span>
<span class="n">mux</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="s">"/api/v1/"</span><span class="p">,</span> <span class="n">http</span><span class="o">.</span><span class="n">StripPrefix</span><span class="p">(</span><span class="s">"/api/v1"</span><span class="p">,</span> <span class="n">gwmux</span><span class="p">))</span>
</pre></td></tr></tbody></table></code></pre></div></div> <h4 id="test-server-with-any-available-port">Test server with any available port</h4> <p>If you hardcode the port number, your CI system might have trouble running two tests at once that both want the same port. Instead, use whichever port available:</p> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="n">grpcLis</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">net</span><span class="o">.</span><span class="n">Listen</span><span class="p">(</span><span class="s">"tcp"</span><span class="p">,</span> <span class="s">"localhost:0"</span><span class="p">)</span>
<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="n">server</span> <span class="o">:=</span> <span class="n">grpc</span><span class="o">.</span><span class="n">NewServer</span><span class="p">()</span>
<span class="c">// ... pb.RegisterSomeServiceServer(s, svc)</span>
<span class="k">go</span> <span class="n">server</span><span class="o">.</span><span class="n">Serve</span><span class="p">(</span><span class="n">grpcLis</span><span class="p">)</span>

<span class="n">conn</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">grpc</span><span class="o">.</span><span class="n">Dial</span><span class="p">(</span><span class="n">srv</span><span class="o">.</span><span class="n">grpcLis</span><span class="o">.</span><span class="n">Addr</span><span class="p">()</span><span class="o">.</span><span class="n">String</span><span class="p">(),</span> <span class="n">grpc</span><span class="o">.</span><span class="n">WithInsecure</span><span class="p">())</span>
<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"did not connect: %v"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="k">defer</span> <span class="n">conn</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>

<span class="n">clnt</span> <span class="o">:=</span> <span class="n">pb</span><span class="o">.</span><span class="n">NewSomeServiceClient</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div> <h3 id="struct">Struct</h3> <h4 id="validate-fields-and-set-default-values">Validate Fields and Set Default Values</h4> <p>It gets verbose to validate configuration input or set default values, like the following. It gets worse when add more fields to <code class="language-plaintext highlighter-rouge">Config</code>.</p> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="k">type</span> <span class="n">Config</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">KubeClientSet</span> <span class="n">kubernetes</span><span class="o">.</span><span class="n">Interface</span>
    <span class="n">StopCh</span>        <span class="o">&lt;-</span><span class="k">chan</span> <span class="k">struct</span><span class="p">{}</span>
    <span class="n">Threadiness</span>   <span class="kt">int</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">NewController</span><span class="p">(</span><span class="n">c</span> <span class="o">*</span><span class="n">Config</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">Controller</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">KubeClientSet</span> <span class="o">==</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="no">nil</span><span class="p">,</span> <span class="n">errors</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="s">"KubeClientSet cannot be nil"</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">StopCh</span> <span class="o">==</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="no">nil</span><span class="p">,</span> <span class="n">errors</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="s">"StopCh cannot be nil"</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">Threadiness</span> <span class="o">==</span> <span class="m">0</span> <span class="p">{</span>
        <span class="n">c</span><span class="o">.</span><span class="n">Threadiness</span> <span class="o">=</span> <span class="m">2</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="n">Controller</span><span class="p">{</span><span class="c">/* ... */</span><span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div> <p>I recommend using <code class="language-plaintext highlighter-rouge">go-playground/validator</code> for validation and <code class="language-plaintext highlighter-rouge">creasty/defaults</code> for setting defaults. Both packages leverage the field tags in struct.</p> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="k">import</span> <span class="p">(</span>
    <span class="s">"github.com/creasty/defaults"</span>
    <span class="s">"github.com/go-playground/validator/v10"</span>
<span class="p">)</span>


<span class="k">type</span> <span class="n">Config</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">KubeClientSet</span> <span class="n">kubernetes</span><span class="o">.</span><span class="n">Interface</span> <span class="s">`validate:"required"`</span>
    <span class="n">StopCh</span>        <span class="o">&lt;-</span><span class="k">chan</span> <span class="k">struct</span><span class="p">{}</span>      <span class="s">`validate:"required"`</span>
    <span class="n">Threadiness</span>   <span class="kt">int</span>                  <span class="s">`default:"2" validate:"gte=0,lte=10"`</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">NewController</span><span class="p">(</span><span class="n">c</span> <span class="o">*</span><span class="n">Config</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">Controller</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">validator</span><span class="o">.</span><span class="n">New</span><span class="p">()</span><span class="o">.</span><span class="n">Struct</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="no">nil</span><span class="p">,</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"invalid config: %v"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">defaults</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="no">nil</span><span class="p">,</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"could not set default values: %v"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="n">Controller</span><span class="p">{</span><span class="c">/* ... */</span><span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div> <h4 id="hashset-with-empty-struct">HashSet with Empty Struct</h4> <p>Empty struct takes exactly zero memory.</p> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="n">strSet</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="k">struct</span><span class="p">{})</span>

<span class="c">// Add to set.</span>
<span class="n">strSet</span><span class="p">[</span><span class="s">"hello"</span><span class="p">]</span> <span class="o">=</span> <span class="k">struct</span><span class="p">{}{}</span>

<span class="c">// Check if the set contains an element.</span>
<span class="k">if</span> <span class="n">_</span><span class="p">,</span> <span class="n">ok</span> <span class="o">:=</span> <span class="n">strSet</span><span class="p">[</span><span class="s">"hello"</span><span class="p">];</span> <span class="n">ok</span> <span class="p">{</span>
    <span class="n">log</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"set contains `hello'"</span><span class="p">)</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div> <h3 id="functional-options">Functional Options</h3> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre></td><td class="rouge-code"><pre><span class="k">type</span> <span class="n">Foo</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">Num</span> <span class="kt">int</span>
    <span class="n">Str</span> <span class="kt">string</span>
<span class="p">}</span>

<span class="k">type</span> <span class="n">Option</span> <span class="k">func</span><span class="p">(</span><span class="n">f</span> <span class="o">*</span><span class="n">Foo</span><span class="p">)</span>

<span class="k">func</span> <span class="n">WithNum</span><span class="p">(</span><span class="n">num</span> <span class="kt">int</span><span class="p">)</span> <span class="n">Option</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">func</span><span class="p">(</span><span class="n">f</span> <span class="o">*</span><span class="n">Foo</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">f</span><span class="o">.</span><span class="n">Num</span> <span class="o">=</span> <span class="n">num</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">WithStr</span><span class="p">(</span><span class="n">str</span> <span class="kt">string</span><span class="p">)</span> <span class="n">Option</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">func</span><span class="p">(</span><span class="n">f</span> <span class="o">*</span><span class="n">Foo</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">f</span><span class="o">.</span><span class="n">Str</span> <span class="o">=</span> <span class="n">str</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">New</span><span class="p">(</span><span class="n">opts</span> <span class="o">...</span><span class="n">Option</span><span class="p">)</span> <span class="o">*</span><span class="n">Foo</span> <span class="p">{</span>
  <span class="n">foo</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">Foo</span><span class="p">{</span>
    <span class="n">num</span><span class="o">:</span> <span class="m">10</span><span class="p">,</span>
    <span class="n">str</span><span class="o">:</span> <span class="s">"hello"</span><span class="p">,</span>
  <span class="p">}</span>

  <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">applyOpt</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">opts</span> <span class="p">{</span>
    <span class="n">applyOpt</span><span class="p">(</span><span class="n">foo</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="o">&amp;</span><span class="n">foo</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">foo</span> <span class="o">:=</span> <span class="n">New</span><span class="p">()</span>
  <span class="n">foo</span> <span class="o">=</span> <span class="n">New</span><span class="p">(</span><span class="n">WithNum</span><span class="p">(</span><span class="m">30</span><span class="p">))</span>
  <span class="n">foo</span> <span class="o">=</span> <span class="n">New</span><span class="p">(</span><span class="n">WithNum</span><span class="p">(</span><span class="m">20</span><span class="p">),</span> <span class="n">WithStr</span><span class="p">(</span><span class="s">"world"</span><span class="p">))</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div> <p>For more details, see <a href="/go-opts">Parameters with Defaults in Go: Functional Options</a></p> <h3 id="certificate-signing-requests-with-email-address">Certificate Signing Requests with Email Address</h3> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre></td><td class="rouge-code"><pre><span class="k">var</span> <span class="n">oidEmailAddress</span> <span class="o">=</span> <span class="n">asn1</span><span class="o">.</span><span class="n">ObjectIdentifier</span><span class="p">{</span><span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">840</span><span class="p">,</span> <span class="m">113549</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">9</span><span class="p">,</span> <span class="m">1</span><span class="p">}</span>

<span class="k">func</span> <span class="n">NewCSR</span><span class="p">(</span><span class="n">commonName</span> <span class="kt">string</span><span class="p">,</span> <span class="n">key</span> <span class="n">crypto</span><span class="o">.</span><span class="n">PrivateKey</span><span class="p">,</span> <span class="n">w</span> <span class="n">io</span><span class="o">.</span><span class="n">Writer</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="n">subj</span> <span class="o">:=</span> <span class="n">pkix</span><span class="o">.</span><span class="n">Name</span><span class="p">{</span>
		<span class="n">CommonName</span><span class="o">:</span>         <span class="n">commonName</span><span class="p">,</span>
		<span class="n">Country</span><span class="o">:</span>            <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"US"</span><span class="p">},</span>
		<span class="n">Province</span><span class="o">:</span>           <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"California"</span><span class="p">},</span>
		<span class="n">Locality</span><span class="o">:</span>           <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"Palo Alto"</span><span class="p">},</span>
		<span class="n">Organization</span><span class="o">:</span>       <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"Pied Piper, Inc."</span><span class="p">},</span>
		<span class="n">OrganizationalUnit</span><span class="o">:</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"Best team"</span><span class="p">},</span>
		<span class="n">ExtraNames</span><span class="o">:</span> <span class="p">[]</span><span class="n">pkix</span><span class="o">.</span><span class="n">AttributeTypeAndValue</span><span class="p">{</span>
			<span class="c">// Crazy dance just to set the email address in CSR.</span>
			<span class="c">// https://stackoverflow.com/questions/26043321/create-a-certificate-signing-request-csr-with-an-email-address-in-go.</span>
			<span class="p">{</span>
				<span class="n">Type</span><span class="o">:</span> <span class="n">oidEmailAddress</span><span class="p">,</span>
				<span class="n">Value</span><span class="o">:</span> <span class="n">asn1</span><span class="o">.</span><span class="n">RawValue</span><span class="p">{</span>
					<span class="n">Tag</span><span class="o">:</span>   <span class="n">asn1</span><span class="o">.</span><span class="n">TagIA5String</span><span class="p">,</span>
					<span class="n">Bytes</span><span class="o">:</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">(</span><span class="s">"foo@example.com"</span><span class="p">),</span>
				<span class="p">},</span>
			<span class="p">},</span>
		<span class="p">},</span>
	<span class="p">}</span>

	<span class="c">// Don't add email addresses to the CertificateRequest EmailAddresses field,</span>
	<span class="c">// which sets a SubjectAltName (SAN). Those are designed more for things</span>
	<span class="c">// like signed emails. In the context of TLS certificates, SANs should be</span>
	<span class="c">// used for alternatively valid hostnames and IP addresses.</span>
	<span class="n">template</span> <span class="o">:=</span> <span class="n">x509</span><span class="o">.</span><span class="n">CertificateRequest</span><span class="p">{</span>
		<span class="n">Subject</span><span class="o">:</span>            <span class="n">subj</span><span class="p">,</span>
		<span class="n">SignatureAlgorithm</span><span class="o">:</span> <span class="n">x509</span><span class="o">.</span><span class="n">SHA256WithRSA</span><span class="p">,</span>
	<span class="p">}</span>

	<span class="n">csrBytes</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">x509</span><span class="o">.</span><span class="n">CreateCertificateRequest</span><span class="p">(</span><span class="n">rand</span><span class="o">.</span><span class="n">Reader</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">template</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">err</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">pem</span><span class="o">.</span><span class="n">Encode</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pem</span><span class="o">.</span><span class="n">Block</span><span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="s">"CERTIFICATE REQUEST"</span><span class="p">,</span> <span class="n">Bytes</span><span class="o">:</span> <span class="n">csrBytes</span><span class="p">})</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div> <h3 id="operators">Operators</h3> <p><code class="language-plaintext highlighter-rouge">^</code> only means bit-wise XOR in Go. For logical XOR, one can use <code class="language-plaintext highlighter-rouge">!=</code>.</p> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="k">var</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="kt">bool</span>
<span class="k">if</span> <span class="n">a</span> <span class="o">!=</span> <span class="n">b</span> <span class="p">{</span>
    <span class="c">// only true if exactly one of {a, b} is true.</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div> </div> </div> </div> </div> <div class="alertbar"> <div class="container text-center"> <span><img src="/assets/images/logo.png" alt="Charles Xu" height="32" width="32"> &nbsp; Never miss a <b>story</b> from me, subscribe to my newsletter</span> <form action="https://gmail.us5.list-manage.com/subscribe/post?u=b3d456844a3860642cd584c1b&amp;id=3f0c5c8bcd" method="post" name="mc-embedded-subscribe-form" class="wj-contact-form validate" target="_blank" novalidate> <div class="mc-field-group"> <input type="email" placeholder="Email" name="EMAIL" class="required email" id="mce-EMAIL" autocomplete="on" required> <input type="submit" value="Subscribe" name="subscribe" class="heart"> </div> </form> </div> </div> </div> <div class="jumbotron fortags"> <div class="d-md-flex h-100"> <div class="col-md-4 transpdark align-self-center text-center h-100"> <div class="d-md-flex align-items-center justify-content-center h-100"> <h2 class="d-md-block align-self-center py-1 font-weight-light">Explore <span class="d-none d-md-inline">→</span></h2> </div> </div> <div class="col-md-8 p-5 align-self-center text-center"> <a class="mt-1 mb-1" href="/categories#git">git (3)</a> <a class="mt-1 mb-1" href="/categories#web">web (6)</a> <a class="mt-1 mb-1" href="/categories#microservices">microservices (3)</a> <a class="mt-1 mb-1" href="/categories#distributed-systems">distributed systems (4)</a> <a class="mt-1 mb-1" href="/categories#signal-processing">signal processing (1)</a> <a class="mt-1 mb-1" href="/categories#istio">istio (3)</a> <a class="mt-1 mb-1" href="/categories#security">security (1)</a> <a class="mt-1 mb-1" href="/categories#docker">docker (2)</a> <a class="mt-1 mb-1" href="/categories#interview">interview (2)</a> <a class="mt-1 mb-1" href="/categories#kubernetes">kubernetes (5)</a> <a class="mt-1 mb-1" href="/categories#operation">operation (2)</a> <a class="mt-1 mb-1" href="/categories#networking">networking (3)</a> <a class="mt-1 mb-1" href="/categories#career">career (5)</a> <a class="mt-1 mb-1" href="/categories#go">go (1)</a> <a class="mt-1 mb-1" href="/categories#shell">shell (1)</a> <a class="mt-1 mb-1" href="/categories#investment">investment (1)</a> <a class="mt-1 mb-1" href="/categories#law">law (1)</a> <a class="mt-1 mb-1" href="/categories#startup">startup (3)</a> <a class="mt-1 mb-1" href="/categories#accounting">accounting (1)</a> <a class="mt-1 mb-1" href="/categories#oss">oss (1)</a> </div> </div> </div> <footer class="footer"> <div class="container"> <div class="row"> <div class="col-md-6 col-sm-6 text-center text-lg-left" style="margin-bottom: 10px;"> Copyright © 2016-2022 Charles Xu </div> </div> </div> </footer> </div> <script src="/assets/js/popper.min.js"></script> <script src="/assets/js/bootstrap.min.js"></script> <script src="/assets/js/mediumish.js"></script> <script src="/assets/js/lazyload.js"></script> <script src="/assets/js/ie10-viewport-bug-workaround.js"></script> <link href="/assets/css/screen.css" rel="stylesheet"> <link href="/assets/css/main.css" rel="stylesheet"> </body> </html>