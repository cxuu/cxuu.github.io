<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <link rel="icon" href="/assets/images/logo.png"> <title>Pagination Ordered by Secondary Keys on Sharded Stores | Charles Xu</title> <title>Pagination Ordered by Secondary Keys on Sharded Stores | Charles Xu</title> <meta name="generator" content="Jekyll v4.2.0"/> <meta property="og:title" content="Pagination Ordered by Secondary Keys on Sharded Stores"/> <meta property="og:locale" content="en_US"/> <meta name="description" content="A common design for content display, pagination partitions information into multiple pages and serves one at a time. We have seen it in search results, message history, and cascading news feed, etc. It shrinks the payload of server response and therefore reduces the response latency."/> <meta property="og:description" content="A common design for content display, pagination partitions information into multiple pages and serves one at a time. We have seen it in search results, message history, and cascading news feed, etc. It shrinks the payload of server response and therefore reduces the response latency."/> <meta property="og:site_name" content="Charles Xu"/> <meta property="og:image" content="/assets/images/pagination/cover.png"/> <meta property="og:type" content="article"/> <meta property="article:published_time" content="2017-04-23T00:00:00-07:00"/> <meta name="twitter:card" content="summary_large_image"/> <meta property="twitter:image" content="/assets/images/pagination/cover.png"/> <meta property="twitter:title" content="Pagination Ordered by Secondary Keys on Sharded Stores"/> <script type="application/ld+json">
{"dateModified":"2017-04-23T00:00:00-07:00","datePublished":"2017-04-23T00:00:00-07:00","mainEntityOfPage":{"@type":"WebPage","@id":"/pagination/"},"url":"/pagination/","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"/assets/images/logo.png"}},"image":"/assets/images/pagination/cover.png","description":"A common design for content display, pagination partitions information into multiple pages and serves one at a time. We have seen it in search results, message history, and cascading news feed, etc. It shrinks the payload of server response and therefore reduces the response latency.","headline":"Pagination Ordered by Secondary Keys on Sharded Stores","@type":"BlogPosting","@context":"https://schema.org"}</script> <link href="/assets/css/bootstrap.min.css" rel="stylesheet"> <script src="/assets/js/jquery.min.js"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-8CYZ0N0EWJ"></script> <script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-8CYZ0N0EWJ");</script> <script>!function(e,t,a,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=t.createElement(a),s=t.getElementsByTagName(a)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-151349369-1","auto"),ga("send","pageview");</script> <script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "5b6e3d4ee3274005a2d3321f9bb0516c"}'></script> </head> <body class="layout-post"> <noscript id="deferred-styles"> <link href="/assets/css/fontawesome.css" rel="stylesheet"> <link href="/assets/css/google-fonts.css" rel="stylesheet"> </noscript> <nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top mediumnavigation nav-down"> <div class="container pr-0"> <a class="navbar-brand" href="/"> <img src="/assets/images/logo.png" alt="Charles Xu" height="32" width="32"> </a> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarMediumish" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <div class="collapse navbar-collapse" id="navbarMediumish"> <ul class="navbar-nav ml-auto"> <li class="nav-item"> <a class="nav-link" href="/about">About</a> </li> <li class="nav-item"> <a class="nav-link" href="/bookshelf">Bookshelf</a> </li> <li class="nav-item"> <a class="nav-link" href="/inspirations">Inspirations</a> </li> <li class="nav-item"> <a class="nav-link" href="/wiki">Wiki</a> </li> <li class="nav-item"> <a class="nav-link" href="/">Blog</a> </li> <script src="/assets/js/lunr.js"></script> <style>.lunrsearchresult .title{color:#d9230f}.lunrsearchresult .url{color:silver}.lunrsearchresult a{display:block;color:#777}.lunrsearchresult a:hover,.lunrsearchresult a:focus{text-decoration:none}.lunrsearchresult a:hover .title{text-decoration:underline}</style> <div style="width: 14px; height: 10px;"></div> <form class="bd-search" onSubmit="return lunr_search(document.getElementById('lunrsearch').value);"> <input type="text" class="form-control text-small launch-modal-search" id="lunrsearch" name="q" maxlength="255" value="" placeholder="Type and enter..."/> </form> <div id="lunrsearchresults"> <ul></ul> </div> <script src="/assets/js/lunrsearchengine.js"></script> </ul> </div> </div> </nav> <div class="site-content"> <div class="container"> <div class="mainheading"> <h1 class="sitetitle">Charles Xu</h1> <p class="lead"> Essays, books, wiki on technologies, career, markets, and more. </p> </div> <div id="loading"> <div id="loading-image" class="lds-ellipsis"><div></div><div></div><div></div><div></div></div> </div> <script>$(window).on("load",function(){$("#loading").hide()});</script> <div class="main-content"> <div class="container"> <div class="row"> <div class="col-md-2 pl-0"> <div class="share sticky-top sticky-top-offset"> <p> Share </p> <ul> <li class="ml-1 mr-1"> <a target="_blank" href="https://twitter.com/intent/tweet?text=Pagination Ordered by Secondary Keys on Sharded Stores&url=charlesxu.io/pagination/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;"> <i class="fab fa-twitter"></i> </a> </li> <li class="ml-1 mr-1"> <a target="_blank" href="https://facebook.com/sharer.php?u=charlesxu.io/pagination/" onclick="window.open(this.href, 'facebook-share', 'width=550,height=435');return false;"> <i class="fab fa-facebook-f"></i> </a> </li> <li class="ml-1 mr-1"> <a target="_blank" href="https://www.linkedin.com/shareArticle?mini=true&url=charlesxu.io/pagination/" onclick="window.open(this.href, 'width=550,height=435');return false;"> <i class="fab fa-linkedin-in"></i> </a> </li> </ul> <div class="sep"> </div> <ul> <li> <a class="small smoothscroll" href="#disqus_thread"></a> </li> </ul> </div> </div> <div class="col-md-8 flex-first flex-md-unordered"> <div class="mainheading"> <h1 class="posttitle">Pagination Ordered by Secondary Keys on Sharded Stores</h1> </div> <img class="featured-image img-fluid lazyimg" style="min-width: 100%" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAMAAAACCAQAAAA3fa6RAAAADklEQVR42mNkAANGCAUAACMAA2w/AMgAAAAASUVORK5CYII=" data-src="/assets/images/pagination/cover.png" alt="Pagination Ordered by Secondary Keys on Sharded Stores"> <div class="article-post"> <p>A common design for content display, pagination partitions information into multiple pages and serves one at a time. We have seen it in search results, message history, and cascading news feed, etc. It shrinks the payload of server response and therefore reduces the response latency.</p> <p>It is often the case that the table in question (1) has a primary key, such as <code class="language-plaintext highlighter-rouge">orderId</code>, <code class="language-plaintext highlighter-rouge">itemId</code>, <code class="language-plaintext highlighter-rouge">msgId</code>, and (2) pagination is sorted on some secondary key such as time, price, popularity. When the table is small, <strong>indexing</strong> on the secondary key plus the SQL <strong>offset/limit</strong> in will do.</p> <p>For higher throughput, the table might be sharded on a partition key, and each table running on different nodes governs a disjoined segment of key space. The partition key is often chosen as the primary key, which makes pagination using secondary keys much more challenging, because none of the nodes have a global view of the entire dataset. We describe three approaches to this problem.</p> <h3 id="external-merging">External Merging</h3> <p>Say the client wants the 3rd page sorted by time from the storage of two shards. Entries are likely interleaved between the two shards, but an extreme case would be that the latest 3 pages all reside on either of the shards. For correctness, we must read the first 3 pages (not just the 3rd) from each shard, then merge the responses in memory on service tier and return the 3rd page from the total order.</p> <p>This may be the most obvious solution, but it does not scale. Imagine the client wants the 100th page and each page has 200 entries. Or you have got multiple shards that are geo-distributed. Now you have to read 20000 entries from each shard and then suffer the high network latency as well as high CPU usage.</p> <h3 id="compromise-no-skipping-but-only-next-page">Compromise: No Skipping but only Next Page</h3> <div style="text-align: center"> <p><img src="/assets/images/pagination/1.png" width="450"/></p> </div> <p>The limit on the page index query only allows the client to visit the next page (e.g. your facebook news feed). This is essentially an optimization over external merging in that each shard always returns only one page for each request. The coordinator/aggregator merges the result and records the highest value of the secondary key from each shard. On the fetching next page, such value is used as the selection condition to get the next load of one page from each shard.</p> <h3 id="lookup-twice">Lookup Twice</h3> <p>Assume each page has 5 rows and we were to get the 200th page. The SQL query is</p> <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">T</span> <span class="k">order</span> <span class="k">by</span> <span class="nb">time</span> <span class="k">offset</span> <span class="mi">1000</span> <span class="k">limit</span> <span class="mi">5</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div> <p>If there are 3 shards in total, rewrite the query as</p> <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">T</span> <span class="k">order</span> <span class="k">by</span> <span class="nb">time</span> <span class="k">offset</span> <span class="mi">333</span> <span class="k">limit</span> <span class="mi">5</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div> <p>and the following is the result from each shard.</p> <div style="text-align: center"> <p><img src="/assets/images/pagination/2.png" width="600"/></p> </div> <p>Then, do a range query using the <code class="language-plaintext highlighter-rouge">between</code> directive, which starts from the <code class="language-plaintext highlighter-rouge">min</code> and ends at the <code class="language-plaintext highlighter-rouge">local_max</code>. The results are shown below.</p> <div style="text-align: center"> <p><img src="/assets/images/pagination/3.png" width="530"/></p> </div> <p>We easily conclude that <code class="language-plaintext highlighter-rouge">min</code> has offset 333 on shard 0, 331 on shard 1, and 330 on shard 2 (offsets rounded down since <code class="language-plaintext highlighter-rouge">min</code> does not really exist on the other shards). It follows that <code class="language-plaintext highlighter-rouge">min</code> on the total order has an offset of 333+331+330 = 994. This is a crucial piece of information, because after an in-memory merging (results from each shard already sorted), we know that the entry 6 rows below <code class="language-plaintext highlighter-rouge">min</code> is of offset 1000 on the global order, and limit 5 is just the next 5 immediate neighbors.</p> </div> <p> <small> <span class="post-date"><time class="post-date" datetime="2017-04-23">23 Apr 2017</time></span> </small> </p> <div class="after-post-cats"> <ul class="tags mb-4"> <li> <a class="smoothscroll" href="/categories#web">web</a> </li> </ul> </div> <div class="after-post-tags"> <ul class="tags"> </ul> </div> <div class="row PageNavigation d-flex justify-content-between font-weight-bold"> <a class="prev d-block col-md-6" href="/kip/"> &laquo; Kip’s Warehouse: Building Scalable, Reliable, Consistent Web Application from the Ground Up</a> <a class="next d-block col-md-6 text-lg-right" href="/session/">Session Consistency in Replicated Frontend Servers &raquo; </a> <div class="clearfix"></div> </div> </div> </div> </div> </div> <div class="alertbar"> <div class="container text-center"> <span><img src="/assets/images/logo.png" alt="Charles Xu" height="32" width="32"> &nbsp; Never miss a <b>story</b> from me, subscribe to my newsletter</span> <form action="https://gmail.us5.list-manage.com/subscribe/post?u=b3d456844a3860642cd584c1b&amp;id=3f0c5c8bcd" method="post" name="mc-embedded-subscribe-form" class="wj-contact-form validate" target="_blank" novalidate> <div class="mc-field-group"> <input type="email" placeholder="Email" name="EMAIL" class="required email" id="mce-EMAIL" autocomplete="on" required> <input type="submit" value="Subscribe" name="subscribe" class="heart"> </div> </form> </div> </div> </div> <div class="jumbotron fortags"> <div class="d-md-flex h-100"> <div class="col-md-4 transpdark align-self-center text-center h-100"> <div class="d-md-flex align-items-center justify-content-center h-100"> <h2 class="d-md-block align-self-center py-1 font-weight-light">Explore <span class="d-none d-md-inline">→</span></h2> </div> </div> <div class="col-md-8 p-5 align-self-center text-center"> <a class="mt-1 mb-1" href="/categories#git">git (3)</a> <a class="mt-1 mb-1" href="/categories#web">web (6)</a> <a class="mt-1 mb-1" href="/categories#microservices">microservices (3)</a> <a class="mt-1 mb-1" href="/categories#distributed-systems">distributed systems (4)</a> <a class="mt-1 mb-1" href="/categories#signal-processing">signal processing (1)</a> <a class="mt-1 mb-1" href="/categories#istio">istio (3)</a> <a class="mt-1 mb-1" href="/categories#security">security (1)</a> <a class="mt-1 mb-1" href="/categories#docker">docker (2)</a> <a class="mt-1 mb-1" href="/categories#interview">interview (2)</a> <a class="mt-1 mb-1" href="/categories#kubernetes">kubernetes (5)</a> <a class="mt-1 mb-1" href="/categories#operation">operation (2)</a> <a class="mt-1 mb-1" href="/categories#networking">networking (3)</a> <a class="mt-1 mb-1" href="/categories#career">career (5)</a> <a class="mt-1 mb-1" href="/categories#go">go (1)</a> <a class="mt-1 mb-1" href="/categories#shell">shell (1)</a> <a class="mt-1 mb-1" href="/categories#investment">investment (1)</a> <a class="mt-1 mb-1" href="/categories#law">law (1)</a> <a class="mt-1 mb-1" href="/categories#startup">startup (3)</a> <a class="mt-1 mb-1" href="/categories#accounting">accounting (1)</a> <a class="mt-1 mb-1" href="/categories#oss">oss (1)</a> </div> </div> </div> <footer class="footer"> <div class="container"> <div class="row"> <div class="col-md-6 col-sm-6 text-center text-lg-left" style="margin-bottom: 10px;"> Copyright © 2016-2022 Charles Xu </div> </div> </div> </footer> </div> <script src="/assets/js/popper.min.js"></script> <script src="/assets/js/bootstrap.min.js"></script> <script src="/assets/js/mediumish.js"></script> <script src="/assets/js/lazyload.js"></script> <script src="/assets/js/ie10-viewport-bug-workaround.js"></script> <link href="/assets/css/screen.css" rel="stylesheet"> <link href="/assets/css/main.css" rel="stylesheet"> </body> </html>